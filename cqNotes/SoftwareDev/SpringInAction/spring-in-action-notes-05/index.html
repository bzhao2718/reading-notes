<!DOCTYPE html><html class="hide-aside" lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Spring In Action Notes (5) | ReadingNotes</title><meta name="keywords" content="reading_notes"><meta name="author"><meta name="copyright"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Ch8 Sending Messages Asynchronously  Asynchronous messaging Sending messages with JMS, RabbitMQ, and Kafka Pulling messages from a broker Listening for messages  Synchronous communication, which is wh">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring In Action Notes (5)">
<meta property="og:url" content="https://bzhao2718.github.io/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-05/index.html">
<meta property="og:site_name" content="ReadingNotes">
<meta property="og:description" content="Ch8 Sending Messages Asynchronously  Asynchronous messaging Sending messages with JMS, RabbitMQ, and Kafka Pulling messages from a broker Listening for messages  Synchronous communication, which is wh">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.pixabay.com/photo/2015/06/08/15/11/typewriter-801921_1280.jpg">
<meta property="article:published_time" content="2021-10-29T18:18:33.000Z">
<meta property="article:modified_time" content="2021-11-07T23:38:57.612Z">
<meta property="article:tag" content="reading_notes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.pixabay.com/photo/2015/06/08/15/11/typewriter-801921_1280.jpg"><link rel="shortcut icon" href="/reading-notes/img/favicon.png"><link rel="canonical" href="https://bzhao2718.github.io/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-05/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/reading-notes/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/reading-notes/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":500},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Spring In Action Notes (5)',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-11-07 17:38:57'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.min.css" media="defer" onload="this.media='all'"><script async src="https://cdn.jsdelivr.net/npm/hexo-butterfly-tag-plugins-plus@latest/lib/carousel-touch.min.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/reading-notes/archives/"><div class="headline">Articles</div><div class="length-num">73</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/reading-notes/tags/"><div class="headline">Tags</div><div class="length-num">16</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/reading-notes/categories/"><div class="headline">Categories</div><div class="length-num">9</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/reading-notes/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/reading-notes/">ReadingNotes</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/reading-notes/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Spring In Action Notes (5)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-10-29T18:18:33.000Z" title="Created 2021-10-29 13:18:33">2021-10-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2021-11-07T23:38:57.612Z" title="Updated 2021-11-07 17:38:57">2021-11-07</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>27min</span></span></div></div></div><article class="post-content" id="article-container"><h1 id="ch8-sending-messages-asynchronously">Ch8 Sending Messages Asynchronously</h1>
<ul>
<li>Asynchronous messaging</li>
<li>Sending messages with JMS, RabbitMQ, and Kafka</li>
<li>Pulling messages from a broker</li>
<li>Listening for messages</li>
</ul>
<p>Synchronous communication, which is what we’ve seen with REST, has its place. But it’s not the only style of inter-application communication available to developers. Asynchronous messaging is a way of indirectly sending messages from one application to another without waiting for a response. This indirection affords looser coupling and greater scalability between the communicating applications.</p>
<p>In this chapter, you’re going to use asynchronous messaging to send orders from the Taco Cloud website to a separate application in the Taco Cloud kitchens where the tacos will be prepared. We’ll consider three options that Spring offers for asynchronous messaging: the Java Message Service (JMS), RabbitMQ and Advanced Message Queueing Protocol (AMQP), and Apache Kafka.</p>
<p><code>OrderReceiverController.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Profile({"jms-template", "rabbitmq-template"})</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping("/orders")</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderReceiverController</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> OrderReceiver orderReceiver;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@GetMapping("/receive")</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">receiveOrder</span><span class="params">(Model model)</span> </span>{</span><br><span class="line">    Order order = orderReceiver.receiveOrder();</span><br><span class="line">    <span class="keyword">if</span> (order != <span class="keyword">null</span>) {</span><br><span class="line">      model.addAttribute(<span class="string">"order"</span>, order);</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"receiveOrder"</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"noOrder"</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>WebConfig.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Profile({"jms-template", "rabbitmq-template"})</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> </span>{</span><br><span class="line">    registry.addRedirectViewController(<span class="string">"/"</span>, <span class="string">"/orders/receive"</span>);</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>OrderReceiver.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderReceiver</span> </span>{</span><br><span class="line">  <span class="function">Order <span class="title">receiveOrder</span><span class="params">()</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>KitchenUI.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KitchenUI</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">displayOrder</span><span class="params">(Order order)</span> </span>{</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Beef this up to do more than just log the received taco.</span></span><br><span class="line">    <span class="comment">//       To display it in some sort of UI.</span></span><br><span class="line">    log.info(<span class="string">"RECEIVED ORDER:  "</span> + order);</span><br><span class="line">  }  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="sending-messages-with-jms">Sending messages with JMS</h2>
<p>JMS is a Java standard that defines a common API for working with message brokers.</p>
<p>Spring supports JMS through a template-based abstraction known as JmsTemplate. Using <code>JmsTemplate</code>, it’s easy to send messages across queues and topics from the producer side and to receive those messages on the consumer side. Spring also supports the notion of message-driven POJOs: simple Java objects that react to messages arriving on a queue or topic in an asynchronous fashion.</p>
<p>But before you can send and receive messages, you need a message broker that’s ready to relay those messages between producers and consumers.</p>
<h3 id="setup-up-a-message-broker">Setup up a message broker</h3>
<p>Setup up a message broker in Spring (Apache ActiveMQ or the newer Apache Active MQ Artemis).</p>
<h3 id="sending-messages-with-jmstemplagte">Sending messages with JmsTemplagte</h3>
<p><code>JmsTemplate</code> is the centerpiece of Spring’s JMS integration support. Much like Spring’s other template-oriented components, JmsTemplate eliminates a lot of boilerplate code that would otherwise be required to work with JMS. Without <code>JmsTemplate</code>, you’d need to write code to create a connection and session with the message broker, and more code to deal with any exceptions that might be thrown in the course of sending a message. <code>JmsTemplate</code> focuses on what you really want to do: send a message.</p>
<p>As you can see, there are really only two methods, <code>send()</code> and <code>convertAndSend()</code>, each overridden to support different parameters. And if you look closer, you’ll notice that the various forms of convertAndSend() can be broken into two subcategories.</p>
<ul>
<li><p>Three <code>send()</code>methods require a <code>MessageCreator</code> to manufacture a <code>Message</code> object.</p></li>
<li><p>Three <code>convertAndSend()</code> methods accept an Object and automatically convert that Object into a <code>Message</code> behind the scenes.</p></li>
<li><p>Three <code>convertAndSend()</code> methods automatically convert an <code>Object</code> to a <code>Message</code>, but also accept a <code>MessagePostProcessor</code> to allow for customization of the <code>Message</code> before it’s sent.</p></li>
</ul>
<p>JmsTemplates’s <code>convertAndSend()</code> method simplifies message publication by eliminating the need to provide a <code>MessageCreator</code>. Instead, you pass the object that’s to be sent directly to <code>convertAndSend()</code>, and the object will be converted into a <code>Message</code> before being sent.</p>
<p>Converting messages before sending</p>
<p>Configuring a message converter</p>
<div class="tabs" id="tacocloudmessaging-jms"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#tacocloudmessaging-jms-1">JmsOrderMessagingService.java</button></li><li class="tab"><button type="button" data-href="#tacocloudmessaging-jms-2">MessagingConfig.java</button></li><li class="tab"><button type="button" data-href="#tacocloudmessaging-jms-3">OrderMessagingService.java</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="tacocloudmessaging-jms-1"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JmsOrderMessagingService</span> <span class="keyword">implements</span> <span class="title">OrderMessagingService</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> JmsTemplate jms;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">JmsOrderMessagingService</span><span class="params">(JmsTemplate jms)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.jms = jms;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendOrder</span><span class="params">(Order order)</span> </span>{</span><br><span class="line">    jms.convertAndSend(<span class="string">"tacocloud.order.queue"</span>, order,</span><br><span class="line">        <span class="keyword">this</span>::addOrderSource);</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">private</span> Message <span class="title">addOrderSource</span><span class="params">(Message message)</span> <span class="keyword">throws</span> JMSException </span>{</span><br><span class="line">    message.setStringProperty(<span class="string">"X_ORDER_SOURCE"</span>, <span class="string">"WEB"</span>);</span><br><span class="line">    <span class="keyword">return</span> message;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="tacocloudmessaging-jms-2"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessagingConfig</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> MappingJackson2MessageConverter <span class="title">messageConverter</span><span class="params">()</span> </span>{</span><br><span class="line">    MappingJackson2MessageConverter messageConverter =</span><br><span class="line">                            <span class="keyword">new</span> MappingJackson2MessageConverter();</span><br><span class="line">    messageConverter.setTypeIdPropertyName(<span class="string">"_typeId"</span>);</span><br><span class="line">    </span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; typeIdMappings = <span class="keyword">new</span> HashMap&lt;String, Class&lt;?&gt;&gt;();</span><br><span class="line">    typeIdMappings.put(<span class="string">"order"</span>, Order.class);</span><br><span class="line">    messageConverter.setTypeIdMappings(typeIdMappings);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> messageConverter;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="tacocloudmessaging-jms-3"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderMessagingService</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">sendOrder</span><span class="params">(Order order)</span></span>;</span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="receiving-jms-messages">Receiving JMS messages</h3>
<p>When it comes to consuming messages, you have the choice of a <code>pull</code> model, where your code requests a message and waits until one arrives, or a <code>push</code> model, in which messages are handed to your code as they become available.</p>
<p><code>JmsTemplate</code> offers several methods for receiving messages, but all of them use a pull model. You call one of those methods to request a message, and the thread blocks until a message is available (which could be immediately or it might take a while).</p>
<p>On the other hand, you also have the option of using a push model, wherein you define a message listener that’s invoked any time a message is available.</p>
<p>Both options are suitable for a variety of use cases. It’s generally accepted that the push model is the best choice, as it doesn’t block a thread. But in some use cases, a listener could be overburdened if messages arrive too quickly. The pull model enables a consumer to declare that they’re ready to process a new message.</p>
<p>Unlike the pull model, where an explicit call to <code>receive()</code> or r<code>eceiveAndConvert()</code>was required to receive a message, a message listener is a passive component that’s idle until a message arrives.</p>
<p>To create a message listener that reacts to JMS messages, you simply must annotate a method in a component with <code>@JmsListener</code>.</p>
<p>The <code>receiveOrder()</code> method is annotated with <code>JmsListener</code> to “listen” for messages on the <code>tacocloud.order.queue</code> destination. It doesn’t deal with <code>JmsTemplate</code>, nor is it explicitly invoked by your application code. Instead, framework code within Spring waits for messages to arrive on the specified destination, and when they arrive, the <code>receiveOrder()</code> method is invoked automatically with the message’s <code>Order</code> payload as a parameter.</p>
<p>In many ways, the <code>@JmsListener</code> annotation is like one of Spring MVC’s request mapping annotations, such as <code>@GetMapping</code> or <code>@PostMapping</code>. In Spring MVC, methods annotated with one of the request mapping methods react to requests to a specified path. Similarly, methods that are annotated with <code>@JmsListener</code> react to messages that arrive in a destination.</p>
<p>Because JMS is defined by a standard Java specification and supported by many message broker implementations, it’s a common choice for messaging in Java. But JMS has a few shortcomings, not the least of which is that as a Java specification its use is limited to Java applications. Newer messaging options such as RabbitMQ and Kafka address these shortcomings and are available for other languages and platforms beyond the JVM.</p>
<p></p><div class="tabs" id="tacocloudkitchen-jms"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#tacocloudkitchen-jms-1">JmsOrderReceiver.java</button></li><li class="tab"><button type="button" data-href="#tacocloudkitchen-jms-2">MessagingConfig.java</button></li><li class="tab"><button type="button" data-href="#tacocloudkitchen-jms-3">OrderListener.java</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="tacocloudkitchen-jms-1"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Profile("jms-template")</span></span><br><span class="line"><span class="meta">@Component("templateOrderReceiver")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JmsOrderReceiver</span> <span class="keyword">implements</span> <span class="title">OrderReceiver</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> JmsTemplate jms;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">JmsOrderReceiver</span><span class="params">(JmsTemplate jms)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.jms = jms;</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Order <span class="title">receiveOrder</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> (Order) jms.receiveAndConvert(<span class="string">"tacocloud.order.queue"</span>);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="tacocloudkitchen-jms-2"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Profile({"jms-template", "jms-listener"})</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessagingConfig</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> MappingJackson2MessageConverter <span class="title">messageConverter</span><span class="params">()</span> </span>{</span><br><span class="line">    MappingJackson2MessageConverter messageConverter =</span><br><span class="line">                            <span class="keyword">new</span> MappingJackson2MessageConverter();</span><br><span class="line">    messageConverter.setTypeIdPropertyName(<span class="string">"_typeId"</span>);</span><br><span class="line">    </span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; typeIdMappings = <span class="keyword">new</span> HashMap&lt;String, Class&lt;?&gt;&gt;();</span><br><span class="line">    typeIdMappings.put(<span class="string">"order"</span>, Order.class);</span><br><span class="line">    messageConverter.setTypeIdMappings(typeIdMappings);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> messageConverter;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="tacocloudkitchen-jms-3"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Profile("jms-listener")</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderListener</span> </span>{</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> KitchenUI ui;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">OrderListener</span><span class="params">(KitchenUI ui)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.ui = ui;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@JmsListener(destination = "tacocloud.order.queue")</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveOrder</span><span class="params">(Order order)</span> </span>{</span><br><span class="line">    ui.displayOrder(order);</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p></p>
<h2 id="working-with-rabbitmq-and-amqp">Working with RabbitMQ and AMQP</h2>
<p>When a message arrives at the RabbitMQ broker, it goes to the exchange for which it was addressed. The exchange is responsible for routing it to one or more queues, depending on the type of exchange, the binding between the exchange and queues, and the value of the message’s routing key.</p>
<img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-05/ch8-rabbitmq-01.png" class="" title="Messages sent to a RabbitMQ exchange are routed to one or more queues, based on routing keys and bindings.">
<p>There are several different kinds of exchanges, including Default, Direct, Topic, Fanout, Headers, Dead Letters.</p>
<p>The simplest forms of exchanges are default and fanout, as these roughly correspond to a JMS queue and topic. But the other exchanges allow you to define more flexible routing schemes.</p>
<p>The most important thing to understand is that messages are sent to exchanges with routing keys and they’re consumed from queues. How they get from an exchange to a queue depends on the binding definitions and what best suits your use cases.</p>
<p>At the core of Spring’s support for RabbitMQ messaging is <code>RabbitTemplate</code>. <code>RabbitTemplate</code> is similar to <code>JmsTemplate</code>, offering a similar set of methods.</p>
<p>As you can see, these methods follow a similar pattern to their twins in <code>JmsTemplate</code>. The first three <code>send()</code> methods all send a raw <code>Message</code> object. The next three <code>convertAndSend()</code> methods accept an object that will be converted to a <code>Message</code> behind the scenes before being sent. The final three <code>convertAndSend()</code> methods are like the previous three, but they accept a <code>MessagePostProcessor</code> that can be used to manipulate the Message object before it’s sent to the broker.</p>
<p>These methods differ from their <code>JmsTemplate</code> counterparts in that they accept String values to specify an exchange and routing key, rather than a destination name (or Destination object). The methods that don’t take an exchange will have their messages sent to the default exchange. Likewise, the methods that don’t take a routing key will have their messages routed with a default routing key.</p>
<h3 id="send-messages">Send messages</h3>
<div class="tabs" id="tacocloudmessaging-rabitmq"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#tacocloudmessaging-rabitmq-1">OrderMessagingService.java</button></li><li class="tab"><button type="button" data-href="#tacocloudmessaging-rabitmq-2">MessagingConfig.java</button></li><li class="tab"><button type="button" data-href="#tacocloudmessaging-rabitmq-3">RabbitOrderMessagingService.java</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="tacocloudmessaging-rabitmq-1"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderMessagingService</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">sendOrder</span><span class="params">(Order order)</span></span>;</span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="tacocloudmessaging-rabitmq-2"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessagingConfig</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Jackson2JsonMessageConverter <span class="title">messageConverter</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Jackson2JsonMessageConverter();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="tacocloudmessaging-rabitmq-3"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitOrderMessagingService</span></span></span><br><span class="line"><span class="class">       <span class="keyword">implements</span> <span class="title">OrderMessagingService</span> </span>{</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> RabbitTemplate rabbit;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">RabbitOrderMessagingService</span><span class="params">(RabbitTemplate rabbit)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.rabbit = rabbit;</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendOrder</span><span class="params">(Order order)</span> </span>{</span><br><span class="line">    rabbit.convertAndSend(<span class="string">"tacocloud.order.queue"</span>, order,</span><br><span class="line">        <span class="keyword">new</span> MessagePostProcessor() {</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> Message <span class="title">postProcessMessage</span><span class="params">(Message message)</span></span></span><br><span class="line"><span class="function">              <span class="keyword">throws</span> AmqpException </span>{</span><br><span class="line">            MessageProperties props = message.getMessageProperties();</span><br><span class="line">            props.setHeader(<span class="string">"X_ORDER_SOURCE"</span>, <span class="string">"WEB"</span>);</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">          } </span><br><span class="line">        });</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h3 id="receive-messages">Receive messages</h3>
<p>First, none of these methods take an exchange or routing key as a parameter. That’s because exchanges and routing keys are used to route messages to queues, but once the messages are in the queue, their next destination is the consumer who pulls them off the queue. Consuming applications needn’t concern themselves with exchanges or routing keys. A queue is the only thing the consuming applications need to know about.</p>
<div class="tabs" id="tacocloudmessaging-rabitmq"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#tacocloudmessaging-rabitmq-1">RabbitOrderReciever.java</button></li><li class="tab"><button type="button" data-href="#tacocloudmessaging-rabitmq-2">RabbitOrderReciever2.java</button></li><li class="tab"><button type="button" data-href="#tacocloudmessaging-rabitmq-3">MessagingConfig.java</button></li><li class="tab"><button type="button" data-href="#tacocloudmessaging-rabitmq-4">OrderListener.java</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="tacocloudmessaging-rabitmq-1"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Profile("rabbitmq-template")</span></span><br><span class="line"><span class="meta">@Component("templateOrderReceiver")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitOrderReceiver</span> <span class="keyword">implements</span> <span class="title">OrderReceiver</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> RabbitTemplate rabbit;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">RabbitOrderReceiver</span><span class="params">(RabbitTemplate rabbit)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.rabbit = rabbit;</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> Order <span class="title">receiveOrder</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> (Order) rabbit.receiveAndConvert(<span class="string">"tacocloud.order.queue"</span>);</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="tacocloudmessaging-rabitmq-2"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitOrderReceiver</span> </span>{</span><br><span class="line">	<span class="keyword">private</span> RabbitTemplate rabbit; </span><br><span class="line">  <span class="keyword">private</span> MessageConverter converter;</span><br><span class="line">	<span class="meta">@Autowired</span> </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">RabbitOrderReceiver</span><span class="params">(RabbitTemplate rabbit)</span> </span>{</span><br><span class="line">	<span class="keyword">this</span>.rabbit = rabbit;</span><br><span class="line">	<span class="keyword">this</span>.converter = rabbit.getMessageConverter(); }</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Order <span class="title">receiveOrder</span><span class="params">()</span> </span>{ </span><br><span class="line">    Message message = rabbit.receive(<span class="string">"tacocloud.orders"</span>); <span class="keyword">return</span> message != <span class="keyword">null</span> ? </span><br><span class="line">      (Order) converter.fromMessage(message) : <span class="keyword">null</span>; }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="tacocloudmessaging-rabitmq-3"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Profile({"rabbitmq-template", "rabbitmq-listener"})</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessagingConfig</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Jackson2JsonMessageConverter <span class="title">messageConverter</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Jackson2JsonMessageConverter();</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="tacocloudmessaging-rabitmq-4"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Profile("rabbitmq-listener")</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderListener</span> </span>{</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> KitchenUI ui;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">OrderListener</span><span class="params">(KitchenUI ui)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.ui = ui;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@RabbitListener(queues = "tacocloud.order.queue")</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveOrder</span><span class="params">(Order order)</span> </span>{</span><br><span class="line">    ui.displayOrder(order);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h2 id="messaging-with-kafka">Messaging with Kafka</h2>
<p>Kafka is designed to run in a cluster, affording great scalability. And by partitioning its topics across all instances in the cluster, it’s very resilient. Whereas RabbitMQ deals primarily with queues in exchanges, Kafka utilizes topics only to offer pub/sub messaging.</p>
<p>Kafka topics are replicated across all brokers in the cluster. Each node in the cluster acts as a leader for one or more topics, being responsible for that topic’s data and replicating it to the other nodes in the cluster.</p>
<p>Going a step further, each topic can be split into multiple partitions. In that case, each node in the cluster is the leader for one or more partitions of a topic, but not for the entire topic. Responsibility for the topic is split across all nodes. Figure 8.2 illustrates how this works.</p>
<p>The <code>handle()</code>method is annotated with <code>@KafkaListener</code> to indicate that it should be invoked when a message arrives in the topic named tacocloud.orders.topic.</p>
<div class="tabs" id="tacocloud-kafka"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#tacocloud-kafka-1">OrderMessagingService.java</button></li><li class="tab"><button type="button" data-href="#tacocloud-kafka-2">KafkaOrderMessagingService.java</button></li><li class="tab"><button type="button" data-href="#tacocloud-kafka-3">OrderListener.java</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="tacocloud-kafka-1"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderMessagingService</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">sendOrder</span><span class="params">(Order order)</span></span>;</span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="tacocloud-kafka-2"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KafkaOrderMessagingService</span></span></span><br><span class="line"><span class="class">                                  <span class="keyword">implements</span> <span class="title">OrderMessagingService</span> </span>{</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> KafkaTemplate&lt;String, Order&gt; kafkaTemplate;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">KafkaOrderMessagingService</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">          KafkaTemplate&lt;String, Order&gt; kafkaTemplate)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.kafkaTemplate = kafkaTemplate;</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendOrder</span><span class="params">(Order order)</span> </span>{</span><br><span class="line">    kafkaTemplate.send(<span class="string">"tacocloud.orders.topic"</span>, order);</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="tacocloud-kafka-3"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Profile("kafka-listener")</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderListener</span> </span>{</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> KitchenUI ui;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">OrderListener</span><span class="params">(KitchenUI ui)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.ui = ui;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@KafkaListener(topics="tacocloud.orders.topic")</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(Order order, ConsumerRecord&lt;String, Order&gt; record)</span> </span>{</span><br><span class="line">    log.info(<span class="string">"Received from partition {} with timestamp {}"</span>,</span><br><span class="line">        record.partition(), record.timestamp());</span><br><span class="line">    </span><br><span class="line">    ui.displayOrder(order);</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Alternate implementation</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  @KafkaListener(topics="tacocloud.orders.topic")</span></span><br><span class="line"><span class="comment">//  public void handle(Order order, Message&lt;Order&gt; message) {</span></span><br><span class="line"><span class="comment">//    MessageHeaders headers = message.getHeaders();</span></span><br><span class="line"><span class="comment">//    log.info("Received from partition {} with timestamp {}",</span></span><br><span class="line"><span class="comment">//        headers.get(KafkaHeaders.RECEIVED_PARTITION_ID),</span></span><br><span class="line"><span class="comment">//        headers.get(KafkaHeaders.RECEIVED_TIMESTAMP));</span></span><br><span class="line"><span class="comment">//    ui.displayOrder(order);</span></span><br><span class="line"><span class="comment">//  }</span></span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h1 id="ch9-integrating-spring">Ch9 Integrating Spring</h1>
<ul>
<li>Processing data in real time</li>
<li>Defining integration flows</li>
<li>Using Spring Integration’s Java DSL definition</li>
<li>Integrating with emails, filesystems, and other external systems</li>
</ul>
<p>And, as data is ingested from or written to these external systems, the application may need to process data in some way to translate it to or from the application’s own domain.</p>
<p>Each pattern is implemented as a component through which messages ferry data in a pipeline. Using Spring configuration, you can assemble these components into a pipeline through which data flows.</p>
<h2 id="declaring-a-simple-integration-flow">Declaring a simple integration flow</h2>
<p>Generally speaking, Spring Integration enables the creation of integration flows through which an application can receive or send data to some resource external to the application itself. One such resource that an application may integrate with is the filesystem. Therefore, among Spring Integration’s many components are channel adapters for reading and writing files.</p>
<p>But, for now, know that the file endpoint module offers the ability to ingest files from the filesystem into an integration flow and/or to write data from a flow to the filesystem.</p>
<p>Although it’s a simple Java interface, there’s a lot to be said about <code>FileWriterGateway</code>. The first thing you’ll notice is that it’s annotated with <code>@MessagingGateway</code>. This annotation tells Spring Integration to generate an implementation of this interface at runtime—similar to how Spring Data automatically generates implementations of repository interfaces. Other parts of the code will use this interface when they need to write a file.</p>
<p>The <code>defaultRequestChannel</code> attribute of <code>@MessagingGateway</code>indicates that any messages resulting from a call to the interface methods should be sent to the given message channel. In this case, you state that any messages that result from a call to <code>writeToFile()</code> should be sent to the channel whose name is <code>textInChannel</code>.</p>
<p>As for the <code>writeToFile()</code> method, it accepts a filename as a String and another String that is to contain the text that should be written to a file. What’s notable about this method signature is that the filename parameter is annotated with <code>@Header</code>. In this case, the <code>@Header</code> annotation indicates that the value passed to filename should be placed in a message header (specified as FileHeaders.FILENAME, which resolves to file_name) rather than in the message payload. The data parameter value, on the other hand, is carried in the message payload.</p>
<p>Now that you’ve a message gateway, you need to configure the integration flow.</p>
<p>Three configuration options for declaring integration flows include these:</p>
<ul>
<li>XML configuration</li>
<li>Java configuration</li>
<li>Java configuration with a DSL</li>
</ul>
<img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-05/ch9-file-integration-channel1.png" class="" title="The file writer integration flow">
<p>With Java configuration, you declare two beans: a transformer and a file-writing message handler. The transformer is a <code>GenericTransformer</code>. Because <code>GenericTransformer</code> is a functional interface, you’re able to provide its implementation as a lambda that calls <code>toUpperCase()</code> on the message text. The transformer bean is annotated with <code>@Transformer</code> designating it as a transformer in the integration flow that receives messages on a channel named <code>textInChannel</code> and writes messages to the channel named <code>fileWriterChannel</code>.</p>
<p>As for the file-writing bean, it’s annotated with <code>@ServiceActivator</code> to indicate that it’ll accept messages from <code>fileWriterChannel</code> and hand those messages over to the service defined by an instance of <code>FileWritingMessageHandler</code>. <code>FileWritingMessageHandler</code> is a message handler that writes a message payload to a file in a specified directory using a filename specified in the message’s file_name header. As with the XML example, <code>FileWritingMessageHandler</code> is configured to append to the file with a newline.</p>
<p>One thing unique about the configuration of the <code>FileWritingMessageHandler</code> bean is that there’s a call to <code>setExpectReply(false)</code> to indicate that the service activator shouldn’t expect a reply channel (a channel through which a value may be returned to upstream components in the flow). If you don’t call <code>setExpectReply()</code>, the filewriting bean defaults to true and, although the pipeline still functions as expected, you’ll see a few errors logged stating that no reply channel was configured.</p>
<p><code>FileWriterGateway.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MessagingGateway(defaultRequestChannel="textInChannel")</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FileWriterGateway</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">writeToFile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="meta">@Header(FileHeaders.FILENAME)</span> String filename,</span></span></span><br><span class="line"><span class="params"><span class="function">      String data)</span></span>;</span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>FileWriterIntegrationConfig.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileWriterIntegrationConfig</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Profile("xmlconfig")</span></span><br><span class="line">  <span class="meta">@Configuration</span></span><br><span class="line">  <span class="meta">@ImportResource("classpath:/filewriter-config.xml")</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">XmlConfiguration</span> </span>{}</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Profile("javaconfig")</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="meta">@Transformer(inputChannel="textInChannel",</span></span><br><span class="line"><span class="meta">               outputChannel="fileWriterChannel")</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> GenericTransformer&lt;String, String&gt; <span class="title">upperCaseTransformer</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> text -&gt; text.toUpperCase();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Profile("javaconfig")</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="meta">@ServiceActivator(inputChannel="fileWriterChannel")</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> FileWritingMessageHandler <span class="title">fileWriter</span><span class="params">()</span> </span>{</span><br><span class="line">    FileWritingMessageHandler handler =</span><br><span class="line">        <span class="keyword">new</span> FileWritingMessageHandler(<span class="keyword">new</span> File(<span class="string">"/tmp/sia5/files"</span>));</span><br><span class="line">    handler.setExpectReply(<span class="keyword">false</span>);</span><br><span class="line">    handler.setFileExistsMode(FileExistsMode.APPEND);</span><br><span class="line">    handler.setAppendNewLine(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> handler;</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// DSL Configuration</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="meta">@Profile("javadsl")</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> IntegrationFlow <span class="title">fileWriterFlow</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> IntegrationFlows</span><br><span class="line">        .from(MessageChannels.direct(<span class="string">"textInChannel"</span>))</span><br><span class="line">        .&lt;String, String&gt;transform(t -&gt; t.toUpperCase())</span><br><span class="line">        .handle(Files</span><br><span class="line">            .outboundAdapter(<span class="keyword">new</span> File(<span class="string">"/tmp/sia5/files"</span>))</span><br><span class="line">            .fileExistsMode(FileExistsMode.APPEND)</span><br><span class="line">            .appendNewLine(<span class="keyword">true</span>))</span><br><span class="line">        .get(); </span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>SimpleFlowApplication.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleFlowApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">		SpringApplication.run(SimpleFlowApplication.class, args);</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> CommandLineRunner <span class="title">writeData</span><span class="params">(FileWriterGateway gateway, Environment env)</span> </span>{</span><br><span class="line">	  <span class="keyword">return</span> args -&gt; {</span><br><span class="line">	    String[] activeProfiles = env.getActiveProfiles();</span><br><span class="line">	    <span class="keyword">if</span> (activeProfiles.length &gt; <span class="number">0</span>) {</span><br><span class="line">	      String profile = activeProfiles[<span class="number">0</span>];</span><br><span class="line">	      gateway.writeToFile(<span class="string">"simple.txt"</span>, <span class="string">"Hello, Spring Integration! ("</span> + profile + <span class="string">")"</span>);</span><br><span class="line">	    } <span class="keyword">else</span> {</span><br><span class="line">	      System.out.println(<span class="string">"No active profile set. Should set active profile to one of xmlconfig, javaconfig, or javadsl."</span>);</span><br><span class="line">	    }</span><br><span class="line">	  };</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="surveying-the-spring-integration-landscape">Surveying the Spring Integration Landscape</h2>
<p>An integration flow is composed of one or more of the following components.</p>
<ul>
<li><p><strong>Channels</strong>—Pass messages from one element to another.</p></li>
<li><p><strong>Filters</strong>—Conditionally allow messages to pass through the flow based on some criteria.</p></li>
<li><p><strong>Transformers</strong>—Change message values and/or convert message payloads from one type to another.</p></li>
<li><p><strong>Routers</strong>—Direct messages to one of several channels, typically based on mes- sage headers.</p></li>
<li><p><strong>Splitters</strong>—Split incoming messages into two or more messages, each sent to dif- ferent channels.</p></li>
<li><p><strong>Aggregators</strong>—The opposite of splitters, combining multiple messages coming in from separate channels into a single message.</p></li>
<li><p><strong>Service activators</strong>—Hand a message off to some Java method for processing, and then publish the return value on an output channel.</p></li>
<li><p><strong>Channel adapters</strong>—Connect a channel to some external system or transport. Can either accept input or write to the external system.</p></li>
<li><p><strong>Gateways</strong>—Pass data into an integration flow via an interface.</p></li>
</ul>
<p>The <code>FileWriterGateway</code> interface was the gateway through which an application submitted text to be written to a file. You also defined a transformer to convert the given text to uppercase; then you declared a service gateway that performed the task of writing the text to a file. And the flow had two channels, <code>textInChannel</code> and <code>fileWriterChannel</code>, that connected the other components with each other.</p>
<p>Gateways are the means by which an application can submit data into an integration flow and, optionally, receive a response that’s the result of the flow. Implemented by Spring Integration, gateways are realized as interfaces that the application can call to send messages to the integration flow</p>
<p>Channel adapters represent the entry and exit points of an integration flow. Data enters an integration flow by way of an inbound channel adapter and exits an integration flow by way of an outbound channel adapter.</p>
<h2 id="creating-an-email-integration-flow">Creating an email integration flow</h2>
<p>In this section, you’ll implement an integration flow that polls the Taco Cloud inbox for taco order emails, parses the emails for order details, and submits the orders to Taco Cloud for handling. In short, the integration flow you’re going to need will use an inbound channel adapter from the email endpoint module to ingest emails from the Taco Cloud inbox into the integration flow.</p>
<p>The next step in the integration flow will parse the emails into order objects that are handed off to another handler to submit orders to Taco Cloud’s REST API, where they’ll be processed the same as any order.</p>
<img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-05/ch9-email-integration.png" class="" title="An integration flow to accept taco orders by email">
<p>You have two options when defining this flow:</p>
<ul>
<li>Define it within the Taco Cloud application itself—At the end of the flow, a service activator will call into the repositories you’ve defined to create the taco order.</li>
<li>Define it as a separate application—At the end of the flow, a service activator will send a POST request to the Taco Cloud API to submit the taco order.</li>
</ul>
<p>But because you’re going to need some types that represent tacos, orders, and ingredients, which are subtly different than those you’ve already defined in the main Taco Cloud application, you’ll proceed by defining the integration flow in a separate application to avoid any confusion with the existing domain types.</p>
<p>The taco order email flow, as defined in the <code>tacoOrderEmailFlow()</code> method, is composed of three distinct components:</p>
<ul>
<li><em>An IMAP email inbound channel adapter</em>—This channel adapter is created with the IMP URL generated from the <code>getImapUrl()</code>method of EmailProperties and polls on a delay set in the <code>pollRate</code> property of <code>EmailProperties</code>. The emails coming in are handed off to a channel connecting it to the transformer.</li>
<li><em>A transformer that transforms an email into an order object</em>—The transformer is implemented in <code>EmailToOrderTransformer</code>, which is injected into the <code>tacoOrderEmailFlow()</code> method. The orders resulting from the transformation are handed off to the final component through another channel.</li>
<li><em>A handler (acting as an outbound channel adapter)</em>—The handler accepts an order object and submits it to Taco Cloud’s REST API.</li>
</ul>
<p>The call to <code>Mail.imapInboundAdapter()</code> is made possible by including the Email endpoint module as a dependency in your project build.</p>
<p><code>AbstractMailMessageTransformer</code> is a convenient base class for handling messages whose payload is an email. It takes care of extracting the email information from the incoming message into a Message object that’s passed into the doTransform() method.</p>
<p>In the <code>doTransform()</code> method, you pass the <code>Message</code> to a private method named <code>processPayload()</code> to parse the email into an <code>Order</code> object. Although similar, the <code>Order</code> object in question isn’t the same as the <code>Order</code> object used in the main Taco Cloud application; it’s slightly simpler:</p>
<p>To satisfy the requirements of the <code>GenericHandler</code> interface, <code>OrderSubmitMessageHandler</code> overrides the <code>handle()</code> method. This method receives the incoming <code>Order</code> object and uses an injected <code>RestTemplate</code> to submit the Order via a POST request to the URL captured in an injected <code>ApiProperties</code> object. Finally, the <code>handle()</code> method returns null to indicate that this handler marks the end of the flow.</p>
<div class="tabs" id="web"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#web-1">ApiProperties</button></li><li class="tab"><button type="button" data-href="#web-2">TacoOrderEmailIntegrationConfig</button></li><li class="tab"><button type="button" data-href="#web-3">TacoEmailApplication</button></li><li class="tab"><button type="button" data-href="#web-4">Taco</button></li><li class="tab"><button type="button" data-href="#web-5">Order</button></li><li class="tab"><button type="button" data-href="#web-6">Ingredient</button></li><li class="tab"><button type="button" data-href="#web-7">OrderSubmitMessageHandler</button></li><li class="tab"><button type="button" data-href="#web-8">EmailToOrderTransformer</button></li><li class="tab"><button type="button" data-href="#web-9">EmailProperties</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="web-1"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = "tacocloud.api")</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiProperties</span> </span>{</span><br><span class="line">  <span class="keyword">private</span> String url;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="web-2"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TacoOrderEmailIntegrationConfig</span> </span>{</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> IntegrationFlow <span class="title">tacoOrderEmailFlow</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      EmailProperties emailProps,</span></span></span><br><span class="line"><span class="params"><span class="function">      EmailToOrderTransformer emailToOrderTransformer,</span></span></span><br><span class="line"><span class="params"><span class="function">      OrderSubmitMessageHandler orderSubmitHandler)</span> </span>{</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> IntegrationFlows</span><br><span class="line">        .from(Mail.imapInboundAdapter(emailProps.getImapUrl()),</span><br><span class="line">            e -&gt; e.poller(</span><br><span class="line">                Pollers.fixedDelay(emailProps.getPollRate())))</span><br><span class="line">        .transform(emailToOrderTransformer)</span><br><span class="line">        .handle(orderSubmitHandler)</span><br><span class="line">        .get();</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="web-3"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TacoEmailApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br><span class="line">		SpringApplication.run(TacoEmailApplication.class, args);</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>{</span><br><span class="line">	  <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="web-4"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Taco</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">  <span class="keyword">private</span> List&lt;String&gt; ingredients;</span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="web-5"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>{</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String email;</span><br><span class="line">  <span class="keyword">private</span> List&lt;Taco&gt; tacos = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addTaco</span><span class="params">(Taco taco)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.tacos.add(taco);</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="web-6"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor(access=AccessLevel.PRIVATE, force=true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Ingredient</span> </span>{</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String code;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="web-7"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderSubmitMessageHandler</span></span></span><br><span class="line"><span class="class">       <span class="keyword">implements</span> <span class="title">GenericHandler</span>&lt;<span class="title">Order</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> RestTemplate rest;</span><br><span class="line">  <span class="keyword">private</span> ApiProperties apiProps;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">OrderSubmitMessageHandler</span><span class="params">(ApiProperties apiProps, RestTemplate rest)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.apiProps = apiProps;</span><br><span class="line">    <span class="keyword">this</span>.rest = rest;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">handle</span><span class="params">(Order order, Map&lt;String, Object&gt; headers)</span> </span>{</span><br><span class="line">    rest.postForObject(apiProps.getUrl(), order, String.class);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="web-8"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Handles email content as taco orders where...&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *  &lt;li&gt; The order's email is the sender's email&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *  &lt;li&gt; The email subject line *must* be "TACO ORDER" or else it will be ignored&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *  &lt;li&gt; Each line of the email starts with the name of a taco design, followed by a colon,</span></span><br><span class="line"><span class="comment"> *    followed by one or more ingredient names in a comma-separated list.&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *    </span></span><br><span class="line"><span class="comment"> * &lt;p&gt;The ingredient names are matched against a known set of ingredients using a LevenshteinDistance</span></span><br><span class="line"><span class="comment"> * algorithm. As an example "beef" will match "GROUND BEEF" and be mapped to "GRBF"; "corn" will</span></span><br><span class="line"><span class="comment"> * match "Corn Tortilla" and be mapped to "COTO".&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * &lt;p&gt;An example email body might look like this:&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * &lt;code&gt;</span></span><br><span class="line"><span class="comment"> * Corn Carnitas: corn, carnitas, lettuce, tomatoes, cheddar&lt;br/&gt;</span></span><br><span class="line"><span class="comment"> * Veggielicious: flour, tomatoes, lettuce, salsa</span></span><br><span class="line"><span class="comment"> * &lt;/code&gt;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * &lt;p&gt;This will result in an order with two tacos where the names are "Corn Carnitas" and "Veggielicious".</span></span><br><span class="line"><span class="comment"> * The ingredients will be {COTO, CARN, LETC, TMTO, CHED} and {FLTO,TMTO,LETC,SLSA}.&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmailToOrderTransformer</span></span></span><br><span class="line"><span class="class">     <span class="keyword">extends</span> <span class="title">AbstractMailMessageTransformer</span>&lt;<span class="title">Order</span>&gt; </span>{</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SUBJECT_KEYWORDS = <span class="string">"TACO ORDER"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> AbstractIntegrationMessageBuilder&lt;Order&gt; </span></span><br><span class="line"><span class="function">                <span class="title">doTransform</span><span class="params">(Message mailMessage)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    Order tacoOrder = processPayload(mailMessage);</span><br><span class="line">    <span class="keyword">return</span> MessageBuilder.withPayload(tacoOrder);</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">private</span> Order <span class="title">processPayload</span><span class="params">(Message mailMessage)</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      String subject = mailMessage.getSubject();</span><br><span class="line">      <span class="keyword">if</span> (subject.toUpperCase().contains(SUBJECT_KEYWORDS)) {</span><br><span class="line">        String email = </span><br><span class="line">              ((InternetAddress) mailMessage.getFrom()[<span class="number">0</span>]).getAddress();</span><br><span class="line">        String content = mailMessage.getContent().toString();</span><br><span class="line">        <span class="keyword">return</span> parseEmailToOrder(email, content);</span><br><span class="line">      }</span><br><span class="line">    } <span class="keyword">catch</span> (MessagingException e) {</span><br><span class="line">    } <span class="keyword">catch</span> (IOException e) {}</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Order <span class="title">parseEmailToOrder</span><span class="params">(String email, String content)</span> </span>{</span><br><span class="line">    Order order = <span class="keyword">new</span> Order(email);</span><br><span class="line">    String[] lines = content.split(<span class="string">"\\r?\\n"</span>);</span><br><span class="line">    <span class="keyword">for</span> (String line : lines) {</span><br><span class="line">      <span class="keyword">if</span> (line.trim().length() &gt; <span class="number">0</span> &amp;&amp; line.contains(<span class="string">":"</span>)) {</span><br><span class="line">        String[] lineSplit = line.split(<span class="string">":"</span>);</span><br><span class="line">        String tacoName = lineSplit[<span class="number">0</span>].trim();</span><br><span class="line">        String ingredients = lineSplit[<span class="number">1</span>].trim();</span><br><span class="line">        String[] ingredientsSplit = ingredients.split(<span class="string">","</span>);</span><br><span class="line">        List&lt;String&gt; ingredientCodes = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String ingredientName : ingredientsSplit) {</span><br><span class="line">          String code = lookupIngredientCode(ingredientName.trim());</span><br><span class="line">          <span class="keyword">if</span> (code != <span class="keyword">null</span>) {</span><br><span class="line">            ingredientCodes.add(code);</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        Taco taco = <span class="keyword">new</span> Taco(tacoName);</span><br><span class="line">        taco.setIngredients(ingredientCodes);</span><br><span class="line">        order.addTaco(taco);</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> order;</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">private</span> String <span class="title">lookupIngredientCode</span><span class="params">(String ingredientName)</span> </span>{</span><br><span class="line">    <span class="keyword">for</span> (Ingredient ingredient : ALL_INGREDIENTS) {</span><br><span class="line">      String ucIngredientName = ingredientName.toUpperCase();</span><br><span class="line">      <span class="keyword">if</span> (LevenshteinDistance.getDefaultInstance().apply(ucIngredientName, ingredient.getName()) &lt; <span class="number">3</span> ||</span><br><span class="line">          ucIngredientName.contains(ingredient.getName()) ||</span><br><span class="line">          ingredient.getName().contains(ucIngredientName)) {</span><br><span class="line">        <span class="keyword">return</span> ingredient.getCode();</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> Ingredient[] ALL_INGREDIENTS = <span class="keyword">new</span> Ingredient[] {</span><br><span class="line">      <span class="keyword">new</span> Ingredient(<span class="string">"FLTO"</span>, <span class="string">"FLOUR TORTILLA"</span>),</span><br><span class="line">      <span class="keyword">new</span> Ingredient(<span class="string">"COTO"</span>, <span class="string">"CORN TORTILLA"</span>),</span><br><span class="line">      <span class="keyword">new</span> Ingredient(<span class="string">"GRBF"</span>, <span class="string">"GROUND BEEF"</span>),</span><br><span class="line">      <span class="keyword">new</span> Ingredient(<span class="string">"CARN"</span>, <span class="string">"CARNITAS"</span>),</span><br><span class="line">      <span class="keyword">new</span> Ingredient(<span class="string">"TMTO"</span>, <span class="string">"TOMATOES"</span>),</span><br><span class="line">      <span class="keyword">new</span> Ingredient(<span class="string">"LETC"</span>, <span class="string">"LETTUCE"</span>),</span><br><span class="line">      <span class="keyword">new</span> Ingredient(<span class="string">"CHED"</span>, <span class="string">"CHEDDAR"</span>),</span><br><span class="line">      <span class="keyword">new</span> Ingredient(<span class="string">"JACK"</span>, <span class="string">"MONTERREY JACK"</span>),</span><br><span class="line">      <span class="keyword">new</span> Ingredient(<span class="string">"SLSA"</span>, <span class="string">"SALSA"</span>),</span><br><span class="line">      <span class="keyword">new</span> Ingredient(<span class="string">"SRCR"</span>, <span class="string">"SOUR CREAM"</span>)</span><br><span class="line">  };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="web-9"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix="tacocloud.email")</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmailProperties</span> </span>{</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> String username;</span><br><span class="line">  <span class="keyword">private</span> String password;</span><br><span class="line">  <span class="keyword">private</span> String host;</span><br><span class="line">  <span class="keyword">private</span> String mailbox;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span> pollRate = <span class="number">30000</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getImapUrl</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> String.format(<span class="string">"imaps://%s:%s@%s/%s"</span>,</span><br><span class="line">        <span class="keyword">this</span>.username, <span class="keyword">this</span>.password, <span class="keyword">this</span>.host, <span class="keyword">this</span>.mailbox);</span><br><span class="line">  } </span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<script type="text&#x2F;javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.7.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.7.0/dist/mindmap.min.css"></article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/reading-notes/tags/reading-notes/">reading_notes</a></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-06/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.pixabay.com/photo/2021/09/09/04/38/binary-6609473_1280.jpg" onerror="onerror=null;src='/reading-notes/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Spring In Action Notes (6)</div></div></a></div><div class="next-post pull-right"><a href="/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-04/"><img class="next-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.pixabay.com/photo/2015/06/08/15/11/typewriter-801921_1280.jpg" onerror="onerror=null;src='/reading-notes/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Spring In Action Notes (4)</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ch8-sending-messages-asynchronously"><span class="toc-number">1.</span> <span class="toc-text">Ch8 Sending Messages Asynchronously</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#sending-messages-with-jms"><span class="toc-number">1.1.</span> <span class="toc-text">Sending messages with JMS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#setup-up-a-message-broker"><span class="toc-number">1.1.1.</span> <span class="toc-text">Setup up a message broker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sending-messages-with-jmstemplagte"><span class="toc-number">1.1.2.</span> <span class="toc-text">Sending messages with JmsTemplagte</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#receiving-jms-messages"><span class="toc-number">1.1.3.</span> <span class="toc-text">Receiving JMS messages</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#working-with-rabbitmq-and-amqp"><span class="toc-number">1.2.</span> <span class="toc-text">Working with RabbitMQ and AMQP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#send-messages"><span class="toc-number">1.2.1.</span> <span class="toc-text">Send messages</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#receive-messages"><span class="toc-number">1.2.2.</span> <span class="toc-text">Receive messages</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#messaging-with-kafka"><span class="toc-number">1.3.</span> <span class="toc-text">Messaging with Kafka</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ch9-integrating-spring"><span class="toc-number">2.</span> <span class="toc-text">Ch9 Integrating Spring</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#declaring-a-simple-integration-flow"><span class="toc-number">2.1.</span> <span class="toc-text">Declaring a simple integration flow</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#surveying-the-spring-integration-landscape"><span class="toc-number">2.2.</span> <span class="toc-text">Surveying the Spring Integration Landscape</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#creating-an-email-integration-flow"><span class="toc-number">2.3.</span> <span class="toc-text">Creating an email integration flow</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="Increase font size"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="Decrease font size"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/reading-notes/js/utils.js"></script><script src="/reading-notes/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/reading-notes/js/search/local-search.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>if (document.getElementsByClassName('mermaid').length) {
  if (window.mermaidJsLoad) mermaid.init()
  else {
    getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(() => {
      window.mermaidJsLoad = true
      mermaid.initialize({
        theme: 'default',
      })
      false && mermaid.init()
    })
  }
}</script></div></div><!-- hexo injector body_end start --><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --></body></html>