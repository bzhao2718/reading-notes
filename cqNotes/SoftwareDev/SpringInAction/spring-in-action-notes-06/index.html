<!DOCTYPE html><html class="hide-aside" lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Spring In Action Notes (6) | ReadingNotes</title><meta name="keywords" content="software_dev,spring"><meta name="author"><meta name="copyright"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Ch10 Introducing Reactor  Understanding reactive programming Project Ractor Operating on data reactively  As we develop application code, there are two styles of code we can write: imperative and reac">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring In Action Notes (6)">
<meta property="og:url" content="https://bzhao2718.github.io/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-06/index.html">
<meta property="og:site_name" content="ReadingNotes">
<meta property="og:description" content="Ch10 Introducing Reactor  Understanding reactive programming Project Ractor Operating on data reactively  As we develop application code, there are two styles of code we can write: imperative and reac">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://bzhao2718.github.io/reading-notes/default_cover/rainbow-5324147_1280.jpg">
<meta property="article:published_time" content="2021-10-29T06:43:45.000Z">
<meta property="article:modified_time" content="2021-11-25T19:03:10.747Z">
<meta property="article:tag" content="software_dev">
<meta property="article:tag" content="spring">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://bzhao2718.github.io/reading-notes/default_cover/rainbow-5324147_1280.jpg"><link rel="shortcut icon" href="/reading-notes/img/favicon.png"><link rel="canonical" href="https://bzhao2718.github.io/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-06/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/reading-notes/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/reading-notes/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":500},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Spring In Action Notes (6)',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-11-26 03:03:10'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://unpkg.zhimg.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/hexo-butterfly-tag-plugins-plus@latest/lib/carousel-touch.min.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/reading-notes/archives/"><div class="headline">Articles</div><div class="length-num">102</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/reading-notes/tags/"><div class="headline">Tags</div><div class="length-num">22</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/reading-notes/categories/"><div class="headline">Categories</div><div class="length-num">12</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/reading-notes/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/reading-notes/">ReadingNotes</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/reading-notes/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Spring In Action Notes (6)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-10-29T06:43:45.000Z" title="Created 2021-10-29 14:43:45">2021-10-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2021-11-25T19:03:10.747Z" title="Updated 2021-11-26 03:03:10">2021-11-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/reading-notes/categories/SoftwareDev/">SoftwareDev</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>26min</span></span></div></div></div><article class="post-content" id="article-container"><h1 id="ch10-introducing-reactor">Ch10 Introducing Reactor</h1>
<ul>
<li>Understanding reactive programming</li>
<li>Project Ractor</li>
<li>Operating on data reactively</li>
</ul>
<p>As we develop application code, there are two styles of code we can
write: imperative and reactive:</p>
<ul>
<li>Imperative code is a lot like that absurd hypothetical newspaper
subscription. It’s a serial set of tasks, each running one at a time,
each after the previous task. Data is processed in bulk and can’t be
handed over to the next task until the previous task has completed its
work on the bulk of data.</li>
<li>Reactive code is a lot like a real newspaper subscription. A set of
tasks is defined to process data, but those tasks can run in parallel.
Each task can process subsets of the data, handing it off to the next
task in line while it continues to work on another subset of the
data.</li>
</ul>
<h2 id="understanding-reactive-programming">Understanding reactive
programming</h2>
<p>The idea is simple: you write code as a list of instructions to be
followed, one at a time, in the order that they’re encountered. A task
is performed and the program waits for it to complete before moving on
to the next task. At each step along the way, the data that’s to be
processed must be fully available so that it can be processed as a
whole.</p>
<p>In contrast, reactive programming is functional and declarative in
nature. Rather than describe a set of steps that are to be performed
sequentially, reactive programming involves describing a pipeline or
stream through which data flows. Rather than requiring the data be
available to be processed as a whole, a reactive stream processes data
as it becomes available. In fact, the incoming data may be endless (a
constant stream of a location’s real-time temperature data, for
instance).</p>
<blockquote>
<p>The term, “reactive,” refers to programming models that are built
around reacting to change — network components reacting to I/O events,
UI controllers reacting to mouse events, and others. In that sense,
non-blocking is reactive, because, instead of being blocked, we are now
in the mode of reacting to notifications as operations complete or data
becomes available.</p>
<p>There is also another important mechanism that we on the Spring team
associate with “reactive” and that is non-blocking back pressure. In
synchronous, imperative code, blocking calls serve as a natural form of
back pressure that forces the caller to wait. In non-blocking code, it
becomes important to control the rate of events so that a fast producer
does not overwhelm its destination.</p>
<p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html">Web
on Reactive Stack</a></p>
</blockquote>
<h3 id="defining-reactive-streams">Defining Reactive Streams</h3>
<p>Reactive Streams aims to provide a standard for asynchronous stream
processing with non-blocking backpressure.</p>
<p>Backpressure is a means by which consumers of data can avoid being
overwhelmed by an overly fast data source, by establishing limits on how
much they’re willing to handle.</p>
<p>The Reactive Streams specification can be summed up by four interface
definitions: <code>Publisher</code>, <code>Subscriber</code>,
<code>Subscription</code>, and <code>Processor</code>. A
<code>Publisher</code> produces data that it sends to a
<code>Subscriber</code> per a <code>Subscription</code>. The
<code>Publisher</code> interface declares a single method,
<code>subscribe()</code>, through which a <code>Subscriber</code> can
subscribe to the <code>Publisher</code>:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Publisher</span>&lt;T&gt; { </span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(Subscriber&lt;? <span class="built_in">super</span> T&gt; subscriber)</span>; </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Once a <code>Subscriber</code> has subscribed, it can receive events
from the <code>Publisher</code>. Those events are sent via methods on
the <code>Subscriber</code> interface:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Subscriber</span>&lt;T&gt; { </span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">onSubscribe</span><span class="params">(Subscription sub)</span>; </span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T item)</span>; </span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable ex)</span>; </span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">onComplete</span><span class="params">()</span>; </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>The first event that the <code>Subscriber</code> will receive is
through a call to <code>onSubscribe()</code>. When the
<code>Publisher</code> calls <code>onSubscribe()</code>, it passes a
<code>Subscription</code> object to the <code>Subscriber</code>. It’s
through the <code>Subscription</code> that the <code>Subscriber</code>
can manage its <code>subscription</code>:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Subscription</span> { </span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">request</span><span class="params">(<span class="type">long</span> n)</span>; </span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">()</span>; </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>The <code>Subscriber</code> can call <code>request()</code> to
request that data be sent, or it can call <code>cancel()</code> to
indicate that it’s no longer interested in receiving data and is
canceling the subscription. When calling <code>request()</code>, the
<code>Subscriber</code> passes in a long value to indicate how many data
items it’s willing to accept. This is where
<strong>backpressure</strong> comes in, preventing the
<code>Publisher</code> from sending more data than the
<code>Subscriber</code> is able to handle. After the
<code>Publisher</code> has sent as many items as were requested, the
<code>Subscriber</code> can call <code>request()</code> again to request
more.</p>
<p>As for the <code>Processor</code> interface, it’s a combination of
<code>Subscriber</code> and <code>Publisher</code>, as shown here:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Processor</span>&lt;T, R&gt; <span class="keyword">extends</span> <span class="title class_">Subscriber</span>&lt;T&gt;, Publisher&lt;R&gt; {}</span><br></pre></td></tr></tbody></table></figure>
<p>As a <code>Subscriber</code>, a <code>Processor</code> will receive
data and process it in some way. Then it will switch hats and act as a
<code>Publisher</code> to publish the results to its
<code>Subscribers</code>.</p>
<p>As you can see, the Reactive Streams specification is rather
straightforward. It’s fairly easy to see how you could build up a
data-processing pipeline that starts with a <code>Publisher</code>,
pumps data through zero or more <code>Processors</code>, and then drops
the final results off to a <code>Subscriber</code>.</p>
<h3 id="getting-started-with-reactor">Getting started with Reactor</h3>
<p>Reactive programming requires us to think in a very different way
from imperative programming. Rather than describe a set of steps to be
taken, reactive programming means building a pipeline through which data
will flow. As data passes through the pipeline, it can be altered or
used in some way.</p>
<p>For now, it’s important to understand that although the reactive
example still seems to follow a step-by-step model, it’s really a
pipeline that data flows through. At each phase of the pipeline, the
data is tweaked somehow, but no assumption can be made about which
thread any of the operations are performed on. They may be the same
thread ... or they may not be.</p>
<p>The <code>Mono</code> in the example is one of Reactor’s two core
types. <code>Flux</code> is the other. Both are implementations of
Reactive Streams’ <code>Publisher</code>. A <code>Flux</code> represents
a pipeline of zero, one, or many (potentially infinite) data items. A
<code>Mono</code> is a specialized reactive type that’s optimized for
when the dataset is known to have no more than one data item.</p>
<p>There are actually three Monos in the previous example. The
<code>just()</code>operation creates the first one. When the
<code>Mono</code> emits a value, that value is given to the
<code>map()</code> operation to be capitalized and used to create
another <code>Mono</code>. When the second <code>Mono</code> publishes
its data, it’s given to the second <code>map()</code>operation to do
some <code>String</code> concatenation, the results of which are used to
create the third <code>Mono</code>. Finally, the call to
<code>subscribe()</code> subscribes to the <code>Mono</code>, receives
the data, and prints it.</p>
<h3 id="diagramming-reactive-flows">Diagramming reactive flows</h3>
<img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-06/ch10-reactor-diagram-01.png" class="" title="ch10-reactor-diagram-01">
<img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-06/ch10-reactor-diagram-02.png" class="" title="ch10-reactor-diagram-02">
<h2 id="applying-common-reactive-operations">Applying common reactive
operations</h2>
<p>Between <code>Flux</code> and <code>Mono</code>, there are over 500
operations, each of which can be loosely categorized as</p>
<ul>
<li>Creation operations</li>
<li>Combination operations</li>
<li>Transformation operations</li>
<li>Logic operations</li>
</ul>
<p>If you have one or more objects that you’d like to create a
<code>Flux</code> or <code>Mono</code> from, you can use the static
<code>just()</code> method on <code>Flux</code> or <code>Mono</code> to
create a reactive type whose data is driven by those objects. For
example, the following test method creates a <code>Flux</code> from five
String objects:</p>
<p>Given a <code>Flux</code> or <code>Mono</code>,
<code>StepVerifier</code> subscribes to the reactive type and then
applies assertions against the data as it flows through the stream,
finally verifying that the stream completes as expected.</p>
<p>The <code>map()</code> operation creates a <code>Flux</code> that
simply performs a transformation as prescribed by a given
<code>Function</code> on each object it receives before republishing
it.</p>
<p>What’s important to understand about <code>map()</code> is that the
mapping is performed synchronously, as each item is published by the
source <code>Flux</code>. If you want to perform the mapping
asynchronously, you should consider the <code>flatMap()</code>
operation.</p>
<p>Instead of simply mapping one object to another, as in the case of
<code>map()</code>, <code>flatMap()</code> maps each object to a new
<code>Mono</code> or <code>Flux</code>. The results of the
<code>Mono</code> or <code>Flux</code> are flattened into a new
resulting <code>Flux</code>. When used along with
<code>subscribeOn()</code>, <code>flatMap()</code> can unleash the
asynchronous power of Reactor’s types.</p>
<p>Although <code>subscribeOn()</code> is named similarly to
<code>subscribe()</code>, they’re quite different. Whereas
<code>subscribe()</code> is a verb, subscribing to a reactive flow and
effectively kicking it off, <code>subscribeOn()</code> is more
descriptive, specifying how a subscription should be handled
concurrently. Reactor doesn’t force any particular concurrency model;
it’s through <code>subscribeOn()</code> that you can specify the
concurrency model, using one of the static methods from
<code>Schedulers</code>, that you want to use. In this example, you used
<code>parallel()</code>, which uses worker threads from a fixed pool
(sized to the number of CPU cores).</p>
<h1 id="ch11-developing-reactive-apis">Ch11 Developing Reactive
APIs</h1>
<ul>
<li>Using Spring WebFlux</li>
<li>Writing and testing reactive controllers and clients</li>
<li>Consuming REST APIs</li>
<li>Securing reactive web applications</li>
</ul>
<h2 id="working-with-spring-webflux">Working with Spring WebFlux</h2>
<p>Typical Servlet-based web frameworks, such as Spring MVC, are
blocking and multithreaded in nature, using a single thread per
connection. As requests are handled, a worker thread is pulled from a
thread pool to process the request. Meanwhile, the request thread is
blocked until it’s notified by the worker thread that it’s finished.</p>
<p>Asynchronous web frameworks, in contrast, achieve higher scalability
with fewer threads—generally one per CPU core. By applying a technique
known as event looping (as illustrated in figure 11.1), these frameworks
are able to handle many requests per thread, making the per-connection
cost more economical.</p>
<img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-06/ch11-event-loop.png" class="" title="Asynchronous web frameworks apply event looping to handle more requests with fewer threads.">
<p>In an event loop, everything is handled as an event, including
requests and callbacks from intensive operations like database and
network operations. When a costly operation is needed, the event loop
registers a callback for that operation to be performed in parallel,
while it moves on to handle other events.</p>
<img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-06/ch11-mvc-webflux-compare.png" class="" title="Spring 5 supports reactive web applications with framework WebFlux.">
<p>Aside from using a different starter dependency, Spring WebFlux
controller methods usually accept and return reactive types, like Mono
and Flux, instead of domain types and collections. Spring WebFlux
controllers can also deal with RxJava types like Observable, Single, and
Completable.</p>
<p>That works fine, but Iterable isn’t a reactive type. You won’t be
able to apply any reactive operations on it, nor can you let the
framework take advantage of it as a reactive type to split any work over
multiple threads. What you’d like is for <code>recentTacos()</code> to
return a <code>Flux&lt;Taco&gt;</code>.</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TacoRepository</span> <span class="keyword">extends</span> <span class="title class_">ReactiveCrudRepository</span>&lt;Taco, Long&gt; { }</span><br></pre></td></tr></tbody></table></figure>
<p>What’s most important to note at this point, however, is that aside
from working with a <code>Flux</code> instead of an Iterable, as well as
how you obtain that Flux, the programming model for defining a reactive
<code>WebFlux</code> controller is no different than for a non-reactive
Spring MVC controller. Both are annotated with
<code>@RestController</code> and a high-level
<code>@RequestMapping</code> at the class level. And both have
request-handling functions that are annotated with
<code>@GetMapping</code> at the method level. It’s truly a matter of
what type the handler methods return.</p>
<p>Another important observation to make is that although you’re getting
a <code>Flux&lt;Taco&gt;</code> back from the repository, you can return
it without calling <code>subscribe()</code>. Indeed, the framework will
call <code>subscribe()</code> for you. This means that when a request
for <code>/design/ recent</code> is handled, the recentTacos() method
will be called and will return before the data is even fetched from the
database!</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("/{id}")</span> </span><br><span class="line"><span class="keyword">public</span> Mono&lt;Taco&gt; <span class="title function_">tacoById</span><span class="params">(<span class="meta">@PathVariable("id")</span> Long id)</span> {</span><br><span class="line">  <span class="keyword">return</span> tacoRepo.findById(id); </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>The original post:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(consumes="application/json")</span></span><br><span class="line"><span class="meta">@ResponseStatus(HttpStatus.CREATED)</span> </span><br><span class="line"><span class="keyword">public</span> Taco <span class="title function_">postTaco</span><span class="params">(<span class="meta">@RequestBody</span> Taco taco)</span> { </span><br><span class="line">  <span class="keyword">return</span> tacoRepo.save(taco); </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>As originally written, <code>postTaco()</code> not only returns a
simple Taco object, but also accepts a Taco object that’s bound to the
content in the body of the request. This means that
<code>postTaco()</code> can’t be invoked until the request payload has
been fully resolved and used to instantiate a Taco object. It also means
<code>postTaco()</code> can’t return until the blocking call to the
repository’s save() method returns. In short, the request is blocked
twice: as it enters <code>postTaco()</code> and again, inside of
<code>postTaco()</code>. But by applying a little reactive coding to
<code>postTaco()</code>, you can make it a fully non-blocking,
request-handling method:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(consumes="application/json")</span></span><br><span class="line"><span class="meta">@ResponseStatus(HttpStatus.CREATED)</span> </span><br><span class="line"><span class="keyword">public</span> Mono&lt;Taco&gt; <span class="title function_">postTaco</span><span class="params">(<span class="meta">@RequestBody</span> Mono&lt;Taco&gt; tacoMono)</span> { </span><br><span class="line">  <span class="keyword">return</span> tacoRepo.saveAll(tacoMono).next(); </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Here, <code>postTaco()</code> accepts a <code>Mono&lt;Taco&gt;</code>
and calls the repository’s <code>saveAll()</code>method, which, as
you’ll see in the next chapter, accepts any implementation of Reactive
Streams’ Publisher, including <code>Mono</code> or <code>Flux</code>.
The <code>saveAll()</code> method returns a
<code>Flux&lt;Taco&gt;</code>, but because you started with a
<code>Mono</code>, you know there’s at most one <code>Taco</code> that
will be published by the <code>Flux</code>. You can therefore call
<code>next()</code> to obtain a <code>Mono&lt;Taco&gt;</code> that will
return from <code>postTaco()</code>.</p>
<p>By accepting a <code>Mono&lt;Taco&gt;</code> as input, the method is
invoked immediately without waiting for the <code>Taco</code> to be
resolved from the request body. And because the repository is also
reactive, it’ll accept a <code>Mono</code> and immediately return a
<code>Flux&lt;Taco&gt;</code>, from which you call <code>next()</code>
and return the resulting <code>Mono&lt;Taco&gt;</code> … all before the
request is even processed!</p>
<h2 id="defining-functional-request-handlers">Defining functional
request handlers</h2>
<p>Writing an API using Spring’s functional programming model involves
four primary types:</p>
<ul>
<li><code>RequestPredicate</code>—Declares the kind(s) of requests that
will be handled</li>
<li><code>RouterFunction</code>—Declares how a matching request should
be routed to han-</li>
<li>dler code</li>
<li><code>ServerRequest</code>—Represents an HTTP request, including
access to header and</li>
<li>body information</li>
<li><code>ServerResponse</code>—Represents an HTTP response, including
header and body</li>
<li>information</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RouterFunctionConfig</span> {</span><br><span class="line">	<span class="meta">@Bean</span> </span><br><span class="line">  <span class="keyword">public</span> RouterFunction&lt;?&gt; helloRouterFunction() {</span><br><span class="line">	<span class="keyword">return</span> route(GET(<span class="string">"/hello"</span>), request -&gt; ok().body(just(<span class="string">"Hello World!"</span>), String.class)); }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>In this <code>@Configuration</code> class, you have a single
<code>@Bean</code> method of type <code>RouterFunction&lt;?&gt;</code>.
As mentioned, a <code>RouterFunction</code> declares mappings between
one or more <code>RequestPredicate</code> objects and the functions that
will handle the matching request(s).</p>
<p>The <code>route()</code> method from <code>RouterFunctions</code>
accepts two parameters: a <code>RequestPredicate</code> and a function
to handle matching requests. In this case, the <code>GET()</code> method
from <code>RequestPredicates</code> declares a
<code>RequestPredicate</code> that matches HTTP GET requests for the
<code>/hello path</code>.</p>
<p>As for the handler function, it’s written as a lambda, although it
can also be a method reference.</p>
<p>But if you need to handle a different kind of request, you don’t have
to write another <code>@Bean</code> method, although you can. You only
need to call <code>andRoute()</code> to declare another
RequestPredicate-to-function mapping.</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span> </span><br><span class="line"><span class="keyword">public</span> RouterFunction&lt;?&gt; helloRouterFunction() { </span><br><span class="line">  <span class="keyword">return</span> route(GET(<span class="string">"/hello"</span>), request -&gt; ok().body(just(<span class="string">"Hello World!"</span>), String.class))</span><br><span class="line">    .andRoute(GET(<span class="string">"/bye"</span>), request -&gt; ok().body(just(<span class="string">"See ya!"</span>), String.class)); </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="testing-reactive-controllers">Testing reactive controllers</h2>
<h2 id="consuming-rest-apis-reactively">Consuming REST APIs
reactively</h2>
<p>It would be nice if there was a way to use <code>RestTemplate</code>
natively with reactive types. Fear not. Spring 5 offers
<code>WebClient</code> as a reactive alternative to
<code>RestTemplate</code>. <code>WebClient</code> lets you both send and
receive reactive types when making requests to external APIs.</p>
<p>Using <code>WebClient</code> is quite different from using
<code>RestTemplate</code>. Rather than have several methods to handle
different kinds of requests, <code>WebClient</code> has a fluent
builderstyle interface that lets you describe and send requests. The
general usage pattern for working with <code>WebClient</code> is</p>
<ul>
<li>Create an instance of <code>WebClient</code> (or inject a
<code>WebClient</code> bean)</li>
<li>Specify the HTTP method of the request to send</li>
<li>Specify the URI and any headers that should be in the request</li>
<li>Submit the request</li>
<li>Consume the response</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Mono&lt;Ingredient&gt; ingredient = WebClient.create()</span><br><span class="line">  .get() </span><br><span class="line">  .uri(<span class="string">"http://localhost:8080/ingredients/{id}"</span>, ingredientId) .retrieve()</span><br><span class="line">  .bodyToMono(Ingredient.class);</span><br><span class="line">ingredient.subscribe(i -&gt; { ... })</span><br></pre></td></tr></tbody></table></figure>
<p>Here you create a new <code>WebClient</code> instance with
<code>create()</code>. Then you use <code>get()</code>and
<code>uri()</code> to define a GET request to
http://localhost:8080/ingredients/{id}, where the {id} placeholder will
be replaced by the value in ingredientId. The retrieve() method executes
the request. Finally, a call to bodyToMono() extracts the response’s
body payload into a <code>Mono&lt;Ingredient&gt;</code> on which you can
continue applying addition <code>Mono</code> operations.</p>
<p>Up to this point, you’ve used the <code>retrieve()</code> method to
signify sending a request when working with <code>WebClient</code>. In
those cases, the <code>retrieve()</code> method returned an object of
type <code>ResponseSpec</code>, through which you were able to handle
the response with calls to methods such as <code>onStatus()</code>,
<code>bodyToFlux()</code>, and <code>bodyToMono()</code>. Working with
<code>ResponseSpec</code> is fine for simple cases, but it’s limited in
a few ways. If you need access to the response’s headers or cookie
values, for example, then ResponseSpec isn’t going to work for you.</p>
<p>When <code>ResponseSpec</code> comes up short, you can try calling
<code>exchange()</code> instead of <code>retrieve()</code>. The
<code>exchange()</code> method returns a <code>Mono</code> of type
<code>ClientResponse</code>, on which you can apply reactive operations
to inspect and use data from the entire response, including the payload,
headers, and cookies.</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Mono&lt;Ingredient&gt; ingredientMono = webClient</span><br><span class="line">  .get() </span><br><span class="line">  .uri(<span class="string">"http://localhost:8080/ingredients/{id}"</span>, ingredientId) </span><br><span class="line">  .exchange()</span><br><span class="line">  .flatMap(cr -&gt; cr.bodyToMono(Ingredient.class));</span><br></pre></td></tr></tbody></table></figure>
<p>This is roughly equivalent to the following example that uses
<code>retrieve()</code>:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Mono&lt;Ingredient&gt; ingredientMono = webClient</span><br><span class="line">  .get() </span><br><span class="line">  .uri(<span class="string">"http://localhost:8080/ingredients/{id}"</span>, ingredientId) </span><br><span class="line">  .retrieve() </span><br><span class="line">  .bodyToMono(Ingredient.class);</span><br></pre></td></tr></tbody></table></figure>
<p>In the <code>exchange()</code> example, rather than use the
<code>ResponseSpec</code> object’s <code>bodyToMono()</code> to get a
<code>Mono&lt;Ingredient&gt;</code>, you get a
<code>Mono&lt;ClientResponse&gt;</code> on which you can apply a
flat-mapping function to map the <code>ClientResponse</code> to
a<code>Mono&lt;Ingredient&gt;</code>, which is flattened into the
resulting <code>Mono</code>.</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Mono&lt;Ingredient&gt; ingredientMono = webClient</span><br><span class="line">  .get() </span><br><span class="line">  .uri(<span class="string">"http://localhost:8080/ingredients/{id}"</span>, ingredientId) </span><br><span class="line">  .exchange() </span><br><span class="line">  .flatMap(cr -&gt; {</span><br><span class="line">    <span class="keyword">if</span> (cr.headers().header(<span class="string">"X_UNAVAILABLE"</span>).contains(<span class="string">"true"</span>)) {</span><br><span class="line">      <span class="keyword">return</span> Mono.empty();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> Mono.just(cr); </span><br><span class="line">  }) </span><br><span class="line">  .flatMap(cr -&gt; cr.bodyToMono(Ingredient.class));</span><br></pre></td></tr></tbody></table></figure>
<p>The new <code>flatMap()</code> call inspects the given
<code>ClientRequest</code> object’s headers, looking for a header named
X_UNAVAILABLE with a value of true. If found, it returns an empty
<code>Mono</code>. Otherwise, it returns a new <code>Mono</code> that
contains the <code>ClientResponse</code>. In either event, the
<code>Mono</code> returned will be flattened into the <code>Mono</code>
that the next <code>flatMap()</code> call will operate on.</p>
<h2 id="securing-reactive-web-apis">Securing reactive web APIs</h2>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span> </span><br><span class="line"><span class="keyword">public</span> ReactiveUserDetailsService <span class="title function_">userDetailsService</span><span class="params">(</span></span><br><span class="line"><span class="params">  UserRepository userRepo)</span> { </span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ReactiveUserDetailsService</span>() { </span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="keyword">public</span> Mono&lt;UserDetails&gt; <span class="title function_">findByUsername</span><span class="params">(String username)</span> { </span><br><span class="line">      <span class="keyword">return</span> userRepo.findByUsername(username) .map(user -&gt; { </span><br><span class="line">        <span class="keyword">return</span> user.toUserDetails(); }); } };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Here, a <code>Mono&lt;UserDetails&gt;</code> is returned as required,
but the <code>UserRepository.findByUsername()</code> method returns a
<code>Mono&lt;User&gt;</code>. Because it’s a Mono, you can chain
operations on it, such as a <code>map()</code> operation to map the
<code>Mono&lt;User&gt;</code> to a
<code>Mono&lt;UserDetails&gt;</code>.</p>
<h2 id="code-files">Code files</h2>
<div class="tabs" id="web"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#web-1">DesignTacoController.java</button></li><li class="tab"><button type="button" data-href="#web-2">RecentTacosController.java</button></li><li class="tab"><button type="button" data-href="#web-3">OrderApiContoller.java</button></li><li class="tab"><button type="button" data-href="#web-4">DesignTacoControllerWebTest.java</button></li><li class="tab"><button type="button" data-href="#web-5">DesignTacoControllerTest.java</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="web-1"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(path = "/design", produces = "application/json")</span></span><br><span class="line"><span class="meta">@CrossOrigin(origins = "*")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DesignTacoController</span> {</span><br><span class="line">  <span class="keyword">private</span> TacoRepository tacoRepo;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">DesignTacoController</span><span class="params">(TacoRepository tacoRepo)</span> {</span><br><span class="line">    <span class="built_in">this</span>.tacoRepo = tacoRepo;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping("/recent")</span></span><br><span class="line">  <span class="keyword">public</span> Flux&lt;Taco&gt; <span class="title function_">recentTacos</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">return</span> tacoRepo.findAll().take(<span class="number">12</span>);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PostMapping(consumes = "application/json")</span></span><br><span class="line">  <span class="meta">@ResponseStatus(HttpStatus.CREATED)</span></span><br><span class="line">  <span class="keyword">public</span> Mono&lt;Taco&gt; <span class="title function_">postTaco</span><span class="params">(<span class="meta">@RequestBody</span> Taco taco)</span> {</span><br><span class="line">    <span class="keyword">return</span> tacoRepo.save(taco);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping("/{id}")</span></span><br><span class="line">  <span class="keyword">public</span> Mono&lt;Taco&gt; <span class="title function_">tacoById</span><span class="params">(<span class="meta">@PathVariable("id")</span> String id)</span> {</span><br><span class="line">    <span class="keyword">return</span> tacoRepo.findById(id);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="web-2"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RepositoryRestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RecentTacosController</span> {</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> TacoRepository tacoRepo;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">RecentTacosController</span><span class="params">(TacoRepository tacoRepo)</span> {</span><br><span class="line">    <span class="built_in">this</span>.tacoRepo = tacoRepo;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping(path="/tacos/recent", produces="application/hal+json")</span></span><br><span class="line">  <span class="keyword">public</span> Mono&lt;ResponseEntity&lt;Resources&lt;TacoResource&gt;&gt;&gt; <span class="title function_">recentTacos</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">return</span> tacoRepo.findAll()</span><br><span class="line">        .take(<span class="number">12</span>)</span><br><span class="line">        .collectList()</span><br><span class="line">        .map(tacos -&gt; {</span><br><span class="line">          List&lt;TacoResource&gt; tacoResources = </span><br><span class="line">              <span class="keyword">new</span> <span class="title class_">TacoResourceAssembler</span>().toResources(tacos);</span><br><span class="line">          Resources&lt;TacoResource&gt; recentResources = </span><br><span class="line">                  <span class="keyword">new</span> <span class="title class_">Resources</span>&lt;TacoResource&gt;(tacoResources);</span><br><span class="line">          </span><br><span class="line">          recentResources.add(</span><br><span class="line">              linkTo(methodOn(RecentTacosController.class).recentTacos())</span><br><span class="line">                  .withRel(<span class="string">"recents"</span>));</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseEntity</span>&lt;&gt;(recentResources, HttpStatus.OK);</span><br><span class="line">        });</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="web-3"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(path="/orders",</span></span><br><span class="line"><span class="meta">                produces="application/json")</span></span><br><span class="line"><span class="meta">@CrossOrigin(origins="*")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderApiController</span> {</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> OrderRepository repo;</span><br><span class="line">  <span class="keyword">private</span> OrderMessagingService orderMessages;</span><br><span class="line">  <span class="keyword">private</span> EmailOrderService emailOrderService;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">OrderApiController</span><span class="params">(OrderRepository repo,</span></span><br><span class="line"><span class="params">                            OrderMessagingService orderMessages,</span></span><br><span class="line"><span class="params">                            EmailOrderService emailOrderService)</span> {</span><br><span class="line">    <span class="built_in">this</span>.repo = repo;</span><br><span class="line">    <span class="built_in">this</span>.orderMessages = orderMessages;</span><br><span class="line">    <span class="built_in">this</span>.emailOrderService = emailOrderService;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping(produces="application/json")</span></span><br><span class="line">  <span class="keyword">public</span> Flux&lt;Order&gt; <span class="title function_">allOrders</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">return</span> repo.findAll();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line"><span class="comment">//  @PostMapping(consumes="application/json")</span></span><br><span class="line"><span class="comment">//  @ResponseStatus(HttpStatus.CREATED)</span></span><br><span class="line"><span class="comment">//  public Mono&lt;Order&gt; postOrder(@RequestBody Mono&lt;Order&gt; order) {</span></span><br><span class="line"><span class="comment">//    order.subscribe(orderMessages::sendOrder); // <span class="doctag">TODO:</span> not ideal...work into reactive flow below</span></span><br><span class="line"><span class="comment">//    return order</span></span><br><span class="line"><span class="comment">//        .flatMap(repo::save);</span></span><br><span class="line"><span class="comment">//  }</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@PostMapping(consumes="application/json")</span></span><br><span class="line">  <span class="meta">@ResponseStatus(HttpStatus.CREATED)</span></span><br><span class="line">  <span class="keyword">public</span> Mono&lt;Order&gt; <span class="title function_">postOrder</span><span class="params">(<span class="meta">@RequestBody</span> Order order)</span> {</span><br><span class="line">    orderMessages.sendOrder(order);</span><br><span class="line">    <span class="keyword">return</span> repo.save(order);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PostMapping(path="fromEmail", consumes="application/json")</span></span><br><span class="line">  <span class="meta">@ResponseStatus(HttpStatus.CREATED)</span></span><br><span class="line">  <span class="keyword">public</span> Mono&lt;Order&gt; <span class="title function_">postOrderFromEmail</span><span class="params">(<span class="meta">@RequestBody</span> Mono&lt;EmailOrder&gt; emailOrder)</span> {</span><br><span class="line">    Mono&lt;Order&gt; order = emailOrderService.convertEmailOrderToDomainOrder(emailOrder);</span><br><span class="line">    order.subscribe(orderMessages::sendOrder); <span class="comment">// <span class="doctag">TODO:</span> not ideal...work into reactive flow below</span></span><br><span class="line">    <span class="keyword">return</span> order</span><br><span class="line">        .flatMap(repo::save);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PutMapping(path="/{orderId}", consumes="application/json")</span></span><br><span class="line">  <span class="keyword">public</span> Mono&lt;Order&gt; <span class="title function_">putOrder</span><span class="params">(<span class="meta">@RequestBody</span> Mono&lt;Order&gt; order)</span> {</span><br><span class="line">    <span class="keyword">return</span> order.flatMap(repo::save);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PatchMapping(path="/{orderId}", consumes="application/json")</span></span><br><span class="line">  <span class="keyword">public</span> Mono&lt;Order&gt; <span class="title function_">patchOrder</span><span class="params">(<span class="meta">@PathVariable("orderId")</span> String orderId,</span></span><br><span class="line"><span class="params">                          <span class="meta">@RequestBody</span> Order patch)</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> repo.findById(orderId)</span><br><span class="line">        .map(order -&gt; {</span><br><span class="line">          <span class="keyword">if</span> (patch.getDeliveryName() != <span class="literal">null</span>) {</span><br><span class="line">            order.setDeliveryName(patch.getDeliveryName());</span><br><span class="line">          }</span><br><span class="line">          <span class="keyword">if</span> (patch.getDeliveryStreet() != <span class="literal">null</span>) {</span><br><span class="line">            order.setDeliveryStreet(patch.getDeliveryStreet());</span><br><span class="line">          }</span><br><span class="line">          <span class="keyword">if</span> (patch.getDeliveryCity() != <span class="literal">null</span>) {</span><br><span class="line">            order.setDeliveryCity(patch.getDeliveryCity());</span><br><span class="line">          }</span><br><span class="line">          <span class="keyword">if</span> (patch.getDeliveryState() != <span class="literal">null</span>) {</span><br><span class="line">            order.setDeliveryState(patch.getDeliveryState());</span><br><span class="line">          }</span><br><span class="line">          <span class="keyword">if</span> (patch.getDeliveryZip() != <span class="literal">null</span>) {</span><br><span class="line">            order.setDeliveryZip(patch.getDeliveryState());</span><br><span class="line">          }</span><br><span class="line">          <span class="keyword">if</span> (patch.getCcNumber() != <span class="literal">null</span>) {</span><br><span class="line">            order.setCcNumber(patch.getCcNumber());</span><br><span class="line">          }</span><br><span class="line">          <span class="keyword">if</span> (patch.getCcExpiration() != <span class="literal">null</span>) {</span><br><span class="line">            order.setCcExpiration(patch.getCcExpiration());</span><br><span class="line">          }</span><br><span class="line">          <span class="keyword">if</span> (patch.getCcCVV() != <span class="literal">null</span>) {</span><br><span class="line">            order.setCcCVV(patch.getCcCVV());</span><br><span class="line">          }</span><br><span class="line">          <span class="keyword">return</span> order;</span><br><span class="line">        })</span><br><span class="line">        .flatMap(repo::save);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@DeleteMapping("/{orderId}")</span></span><br><span class="line">  <span class="meta">@ResponseStatus(HttpStatus.NO_CONTENT)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteOrder</span><span class="params">(<span class="meta">@PathVariable("orderId")</span> String orderId)</span> {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      repo.deleteById(orderId);</span><br><span class="line">    } <span class="keyword">catch</span> (EmptyResultDataAccessException e) {}</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="web-4"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@WebFluxTest(controllers=DesignTacoController.class)</span></span><br><span class="line"><span class="meta">@ContextConfiguration(classes=DesignTacoController.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DesignTacoControllerWebTest</span> {</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> WebTestClient testClient;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@MockBean</span></span><br><span class="line">  <span class="keyword">private</span> TacoRepository tacoRepo;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shouldReturnRecentTacos</span><span class="params">()</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    Taco[] tacos = {</span><br><span class="line">        testTaco(<span class="number">1L</span>), testTaco(<span class="number">2L</span>), testTaco(<span class="number">3L</span>), testTaco(<span class="number">4L</span>),</span><br><span class="line">        testTaco(<span class="number">5L</span>), testTaco(<span class="number">6L</span>), testTaco(<span class="number">7L</span>), testTaco(<span class="number">8L</span>),</span><br><span class="line">        testTaco(<span class="number">9L</span>), testTaco(<span class="number">10L</span>), testTaco(<span class="number">11L</span>), testTaco(<span class="number">12L</span>)};</span><br><span class="line"></span><br><span class="line">    Mockito.when(tacoRepo.findAll())</span><br><span class="line">      .thenReturn(Flux.fromArray(tacos));</span><br><span class="line">    </span><br><span class="line">    testClient.get().uri(<span class="string">"/design/recent"</span>)</span><br><span class="line">      .accept(MediaType.APPLICATION_JSON)</span><br><span class="line">      .exchange()</span><br><span class="line">      .expectStatus().isOk()</span><br><span class="line">      .expectBodyList(Taco.class).contains(tacos);</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> Taco <span class="title function_">testTaco</span><span class="params">(Long number)</span> {</span><br><span class="line">    <span class="type">Taco</span> <span class="variable">taco</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Taco</span>();</span><br><span class="line">    taco.setId(UUID.randomUUID());</span><br><span class="line">    taco.setName(<span class="string">"Taco "</span> + number);</span><br><span class="line">    List&lt;IngredientUDT&gt; ingredients = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    ingredients.add(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">IngredientUDT</span>(<span class="string">"Ingredient A"</span>, Type.WRAP));</span><br><span class="line">    ingredients.add(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">IngredientUDT</span>(<span class="string">"Ingredient B"</span>, Type.PROTEIN));</span><br><span class="line">    taco.setIngredients(ingredients);</span><br><span class="line">    <span class="keyword">return</span> taco;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="web-5"><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DesignTacoControllerTest</span> {</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shouldReturnRecentTacos</span><span class="params">()</span> {</span><br><span class="line">    Taco[] tacos = {</span><br><span class="line">        testTaco(<span class="number">1L</span>), testTaco(<span class="number">2L</span>),</span><br><span class="line">        testTaco(<span class="number">3L</span>), testTaco(<span class="number">4L</span>),</span><br><span class="line">        testTaco(<span class="number">5L</span>), testTaco(<span class="number">6L</span>),</span><br><span class="line">        testTaco(<span class="number">7L</span>), testTaco(<span class="number">8L</span>),</span><br><span class="line">        testTaco(<span class="number">9L</span>), testTaco(<span class="number">10L</span>),</span><br><span class="line">        testTaco(<span class="number">11L</span>), testTaco(<span class="number">12L</span>),</span><br><span class="line">        testTaco(<span class="number">13L</span>), testTaco(<span class="number">14L</span>),</span><br><span class="line">        testTaco(<span class="number">15L</span>), testTaco(<span class="number">16L</span>)};</span><br><span class="line">    Flux&lt;Taco&gt; tacoFlux = Flux.just(tacos);</span><br><span class="line">    </span><br><span class="line">    <span class="type">TacoRepository</span> <span class="variable">tacoRepo</span> <span class="operator">=</span> Mockito.mock(TacoRepository.class);</span><br><span class="line">    when(tacoRepo.findAll()).thenReturn(tacoFlux);</span><br><span class="line">    </span><br><span class="line">    <span class="type">WebTestClient</span> <span class="variable">testClient</span> <span class="operator">=</span> WebTestClient.bindToController(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">DesignTacoController</span>(tacoRepo))</span><br><span class="line">        .build();</span><br><span class="line">    </span><br><span class="line">    testClient.get().uri(<span class="string">"/design/recent"</span>)</span><br><span class="line">      .exchange()</span><br><span class="line">      .expectStatus().isOk()</span><br><span class="line">      .expectBody()</span><br><span class="line">        .jsonPath(<span class="string">"$"</span>).isArray()</span><br><span class="line">        .jsonPath(<span class="string">"$"</span>).isNotEmpty()</span><br><span class="line">        .jsonPath(<span class="string">"$[0].id"</span>).isEqualTo(tacos[<span class="number">0</span>].getId().toString())</span><br><span class="line">        .jsonPath(<span class="string">"$[0].name"</span>).isEqualTo(<span class="string">"Taco 1"</span>)</span><br><span class="line">        .jsonPath(<span class="string">"$[1].id"</span>).isEqualTo(tacos[<span class="number">1</span>].getId().toString())</span><br><span class="line">        .jsonPath(<span class="string">"$[1].name"</span>).isEqualTo(<span class="string">"Taco 2"</span>)</span><br><span class="line">        .jsonPath(<span class="string">"$[11].id"</span>).isEqualTo(tacos[<span class="number">11</span>].getId().toString())</span><br><span class="line">        .jsonPath(<span class="string">"$[11].name"</span>).isEqualTo(<span class="string">"Taco 12"</span>)</span><br><span class="line">        .jsonPath(<span class="string">"$[12]"</span>).doesNotExist();</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shouldSaveATaco</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">TacoRepository</span> <span class="variable">tacoRepo</span> <span class="operator">=</span> Mockito.mock(</span><br><span class="line">                TacoRepository.class);</span><br><span class="line">    Mono&lt;Taco&gt; unsavedTacoMono = Mono.just(testTaco(<span class="literal">null</span>));</span><br><span class="line">    <span class="type">Taco</span> <span class="variable">savedTaco</span> <span class="operator">=</span> testTaco(<span class="literal">null</span>);</span><br><span class="line">    savedTaco.setId(UUID.randomUUID());</span><br><span class="line">    Mono&lt;Taco&gt; savedTacoMono = Mono.just(savedTaco);</span><br><span class="line">    </span><br><span class="line">    when(tacoRepo.save(any())).thenReturn(savedTacoMono);</span><br><span class="line">    </span><br><span class="line">    <span class="type">WebTestClient</span> <span class="variable">testClient</span> <span class="operator">=</span> WebTestClient.bindToController(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">DesignTacoController</span>(tacoRepo)).build();</span><br><span class="line">    </span><br><span class="line">    testClient.post()</span><br><span class="line">        .uri(<span class="string">"/design"</span>)</span><br><span class="line">        .contentType(MediaType.APPLICATION_JSON)</span><br><span class="line">        .body(unsavedTacoMono, Taco.class)</span><br><span class="line">      .exchange()</span><br><span class="line">      .expectStatus().isCreated()</span><br><span class="line">      .expectBody(Taco.class)</span><br><span class="line">        .isEqualTo(savedTaco);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> Taco <span class="title function_">testTaco</span><span class="params">(Long number)</span> {</span><br><span class="line">    <span class="type">Taco</span> <span class="variable">taco</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Taco</span>();</span><br><span class="line">    taco.setId(UUID.randomUUID());</span><br><span class="line">    taco.setName(<span class="string">"Taco "</span> + number);</span><br><span class="line">    List&lt;IngredientUDT&gt; ingredients = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    ingredients.add(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">IngredientUDT</span>(<span class="string">"Ingredient A"</span>, Type.WRAP));</span><br><span class="line">    ingredients.add(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">IngredientUDT</span>(<span class="string">"Ingredient B"</span>, Type.PROTEIN));</span><br><span class="line">    taco.setIngredients(ingredients);</span><br><span class="line">    <span class="keyword">return</span> taco;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>
<h1 id="ch12-persisting-data-reactively">Ch12 Persisting data
reactively</h1>
<p>In the previous chapter, you saw how to create reactive, non-blocking
controllers with Spring WebFlux. This helps to improve scalability in
the web layer. But those controllers are only truly non-blocking if
other components that they work with are also non-blocking. If we write
Spring WebFlux controllers that still depend on blocking repositories,
our reactive controllers will be blocked waiting for them to produce
data.</p>
<p>Therefore, it’s important that the entire flow of data, all the way
from the controllers to the database, be reactive and non-blocking.</p>
<p>The essence of Spring Data’s reactive story can be summed up by
saying that reactive repositories have methods that accept and return
<code>Mono</code> and <code>Flux</code> instead of domain entities and
collections.</p>
<p>Put simply, Spring Data’s reactive repositories share a
near-identical programming model with Spring Data’s non-reactive
repositories, like those in chapter 3. The only material difference is
that reactive repositories have methods that take and return Flux and
Mono instead of raw domain types and collections.</p>
<p>Although the full benefit of reactive programming comes when you have
a reactive model from end to end, including at the database level,
there’s still some benefit to be had by using reactive flows on top of a
non-reactive database. Even though your chosen database doesn’t support
non-blocking reactive queries, you can still fetch data in a blocking
fashion and then translate it into a reactive type as soon as possible
for the benefit of upstream components.</p>
<p>You can’t do anything about the blocking nature of invoking a method
on a JPA repository. What you can do, however, is convert the
non-reactive List into a <code>Flux</code> as soon as you receive it, so
that you can deal with the results reactively from there on.</p>
<script type="text&#x2F;javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.7.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.7.0/dist/mindmap.min.css"></article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/reading-notes/tags/software-dev/">software_dev</a><a class="post-meta__tags" href="/reading-notes/tags/spring/">spring</a></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-07/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/reading-notes/default_cover/monk-6113501_1920.png" onerror="onerror=null;src='/reading-notes/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Spring In Action Notes (7)</div></div></a></div><div class="next-post pull-right"><a href="/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-05/"><img class="next-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/reading-notes/default_cover/monk-6113501_1920.png" onerror="onerror=null;src='/reading-notes/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Spring In Action Notes (5)</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-07/" title="Spring In Action Notes (7)"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/reading-notes/default_cover/monk-6113501_1920.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-01</div><div class="title">Spring In Action Notes (7)</div></div></a></div><div><a href="/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-04/" title="Spring In Action Notes (4)"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/reading-notes/default_cover/museum-5431661_1280.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-28</div><div class="title">Spring In Action Notes (4)</div></div></a></div><div><a href="/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-03/" title="Spring In Action Notes (3)"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/reading-notes/default_cover/microsoft-edge-mt4xBHKxFH4-unsplash.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-28</div><div class="title">Spring In Action Notes (3)</div></div></a></div><div><a href="/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-02/" title="Spring In Action Notes (2)"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/reading-notes/default_cover/museum-5431661_1280.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-27</div><div class="title">Spring In Action Notes (2)</div></div></a></div><div><a href="/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-01/" title="Spring In Action Reading Notes (1)"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/reading-notes/default_cover/museum-5431661_1280.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-26</div><div class="title">Spring In Action Reading Notes (1)</div></div></a></div><div><a href="/reading-notes/cqNotes/Java/cq_springboot/" title="cq_sprintboot"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/reading-notes/default_cover/circles-5444818_1280.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-01</div><div class="title">cq_sprintboot</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ch10-introducing-reactor"><span class="toc-number">1.</span> <span class="toc-text">Ch10 Introducing Reactor</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#understanding-reactive-programming"><span class="toc-number">1.1.</span> <span class="toc-text">Understanding reactive
programming</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#defining-reactive-streams"><span class="toc-number">1.1.1.</span> <span class="toc-text">Defining Reactive Streams</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getting-started-with-reactor"><span class="toc-number">1.1.2.</span> <span class="toc-text">Getting started with Reactor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#diagramming-reactive-flows"><span class="toc-number">1.1.3.</span> <span class="toc-text">Diagramming reactive flows</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#applying-common-reactive-operations"><span class="toc-number">1.2.</span> <span class="toc-text">Applying common reactive
operations</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ch11-developing-reactive-apis"><span class="toc-number">2.</span> <span class="toc-text">Ch11 Developing Reactive
APIs</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#working-with-spring-webflux"><span class="toc-number">2.1.</span> <span class="toc-text">Working with Spring WebFlux</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#defining-functional-request-handlers"><span class="toc-number">2.2.</span> <span class="toc-text">Defining functional
request handlers</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#testing-reactive-controllers"><span class="toc-number">2.3.</span> <span class="toc-text">Testing reactive controllers</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#consuming-rest-apis-reactively"><span class="toc-number">2.4.</span> <span class="toc-text">Consuming REST APIs
reactively</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#securing-reactive-web-apis"><span class="toc-number">2.5.</span> <span class="toc-text">Securing reactive web APIs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#code-files"><span class="toc-number">2.6.</span> <span class="toc-text">Code files</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ch12-persisting-data-reactively"><span class="toc-number">3.</span> <span class="toc-text">Ch12 Persisting data
reactively</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="Increase font size"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="Decrease font size"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/reading-notes/js/utils.js"></script><script src="/reading-notes/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/reading-notes/js/search/local-search.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>if (document.getElementsByClassName('mermaid').length) {
  if (window.mermaidJsLoad) mermaid.init()
  else {
    getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(() => {
      window.mermaidJsLoad = true
      mermaid.initialize({
        theme: 'default',
      })
      false && mermaid.init()
    })
  }
}</script></div></div><!-- hexo injector body_end start --><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --></body></html>