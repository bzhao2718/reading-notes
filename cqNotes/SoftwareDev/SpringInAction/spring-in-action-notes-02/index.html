<!DOCTYPE html><html class="hide-aside" lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Spring In Action Notes (2) | ReadingNotes</title><meta name="keywords" content="software_dev,spring"><meta name="author"><meta name="copyright"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Ch3 Working With Data When it comes to working with relational data, Java developers have several options. The two most common choices are JDBC and the JPA. Using Spring’s JdbcTemplate By annotating J">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring In Action Notes (2)">
<meta property="og:url" content="https://bzhao2718.github.io/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-02/index.html">
<meta property="og:site_name" content="ReadingNotes">
<meta property="og:description" content="Ch3 Working With Data When it comes to working with relational data, Java developers have several options. The two most common choices are JDBC and the JPA. Using Spring’s JdbcTemplate By annotating J">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://bzhao2718.github.io/reading-notes/default_cover/trees-6207925_1920.jpg">
<meta property="article:published_time" content="2021-10-27T04:07:15.000Z">
<meta property="article:modified_time" content="2021-11-25T19:02:31.376Z">
<meta property="article:tag" content="software_dev">
<meta property="article:tag" content="spring">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://bzhao2718.github.io/reading-notes/default_cover/trees-6207925_1920.jpg"><link rel="shortcut icon" href="/reading-notes/img/favicon.png"><link rel="canonical" href="https://bzhao2718.github.io/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-02/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/reading-notes/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/reading-notes/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":500},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Spring In Action Notes (2)',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-11-26 03:02:31'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://unpkg.zhimg.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/hexo-butterfly-tag-plugins-plus@latest/lib/carousel-touch.min.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/reading-notes/archives/"><div class="headline">Articles</div><div class="length-num">86</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/reading-notes/tags/"><div class="headline">Tags</div><div class="length-num">22</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/reading-notes/categories/"><div class="headline">Categories</div><div class="length-num">12</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/reading-notes/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/reading-notes/">ReadingNotes</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/reading-notes/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/reading-notes/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Spring In Action Notes (2)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-10-27T04:07:15.000Z" title="Created 2021-10-27 12:07:15">2021-10-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2021-11-25T19:02:31.376Z" title="Updated 2021-11-26 03:02:31">2021-11-26</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/reading-notes/categories/SoftwareDev/">SoftwareDev</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>18min</span></span></div></div></div><article class="post-content" id="article-container"><h1 id="ch3-working-with-data">Ch3 Working With Data</h1>
<p>When it comes to working with relational data, Java developers have several options. The two most common choices are JDBC and the JPA.</p>
<h2 id="using-springs-jdbctemplate">Using Spring’s JdbcTemplate</h2>
<p>By annotating JdbcIngredientRepository with <code>@Repository</code>, you declare that it should be automatically discovered by Spring component scanning and instantiated as a bean in the Spring application context. When the query is performed, the <code>?</code> will be replaced with this value.</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Optional&lt;Ingredient&gt; <span class="title function_">findById</span><span class="params">(String id)</span> {</span><br><span class="line">List&lt;Ingredient&gt; results = jdbcTemplate.query(<span class="string">"select id, name, type from Ingredient where id=?"</span>, <span class="built_in">this</span>::mapRowToIngredient, id); </span><br><span class="line"><span class="keyword">return</span> results.size() == <span class="number">0</span> ? Optional.empty() : Optional.of(results.get(<span class="number">0</span>));</span><br><span class="line">} </span><br><span class="line"><span class="keyword">private</span> Ingredient <span class="title function_">mapRowToIngredient</span><span class="params">(ResultSet row, <span class="type">int</span> rowNum)</span> <span class="keyword">throws</span> SQLException{ <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Ingredient</span>( </span><br><span class="line">  row.getString(<span class="string">"id"</span>), </span><br><span class="line">  row.getString(<span class="string">"name"</span>), </span><br><span class="line">  Ingredient.Type.valueOf(row.getString(<span class="string">"type"</span>))); </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-02/ch3_db_schema.png" class="" title="The TacoCloud Schema.">
<p>Aggregates and aggregate roots are core concepts of Domain Driven Design, a design approach that promotes the idea that the structure and language of software code should match the business domain. In our application, a <code>Taco</code> can’t exist outside of the context of a <code>Taco_Order</code>. Thus, <code>Taco_Order</code> and <code>Taco</code> are considered members of an aggregate where <code>Taco_Order</code> is the aggregate root.</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> Taco <span class="keyword">add</span> <span class="keyword">foreign</span> key (taco_order) <span class="keyword">references</span> Taco_Order(id); </span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> Ingredient_Ref <span class="keyword">add</span> <span class="keyword">foreign</span> key (ingredient) <span class="keyword">references</span> Ingredient(id);</span><br></pre></td></tr></tbody></table></figure>
<p>A <code>TacoOrder</code> object has a list of <code>Taco</code> objects and a <code>Taco</code> object has a list of <code>Ingredient</code>(IngredientRef) objects. First we save the <code>TacoOrder</code> and get the id of the row for that <code>TacoOrder</code>. Then we use <code>List&lt;Taco&gt; tacos = tacoOrder.getTacos()</code> to get all the tacos in that order and for each of them, we call <code>saveTaco(tacoOrder_id, taco,...)</code> to save all tacos with the <code>tacoOrder_id</code>. Similarly, we get a taco_id for each of the taco and pass that taco_id to save a list of ingredients for that taco.</p>
<p>After the order data has been saved, the <code>GeneratedKeyHolder</code> will contain the value of the id field as assigned by the database and should be copied into the <code>TacoOrder</code> object’s id property.</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="title function_">saveTaco</span><span class="params">(Long orderId, <span class="type">int</span> orderKey, Taco taco)</span> { </span><br><span class="line">  taco.setCreatedAt(<span class="keyword">new</span> <span class="title class_">Date</span>()); </span><br><span class="line">  <span class="type">PreparedStatementCreatorFactory</span> <span class="variable">pscf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PreparedStatementCreatorFactory</span>( <span class="string">"insert into Taco "</span> + <span class="string">"(name, created_at, taco_order, taco_order_key) "</span> + <span class="string">"values (?, ?, ?, ?)"</span>, Types.VARCHAR, Types.TIMESTAMP, Type.LONG, Type.LONG );</span><br><span class="line">  pscf.setReturnGeneratedKeys(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">PreparedStatementCreator</span> <span class="variable">psc</span> <span class="operator">=</span> pscf.newPreparedStatementCreator( Arrays.asList( taco.getName(), taco.getCreatedAt(), orderId, orderKey));</span><br><span class="line">  <span class="type">GeneratedKeyHolder</span> <span class="variable">keyHolder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GeneratedKeyHolder</span>(); </span><br><span class="line">  jdbcOperations.update(psc, keyHolder); </span><br><span class="line">  <span class="type">long</span> <span class="variable">tacoId</span> <span class="operator">=</span> keyHolder.getKey().longValue(); </span><br><span class="line">  taco.setId(tacoId);</span><br><span class="line">  saveIngredientRef(tacoId, taco.getIngredients());</span><br><span class="line">  <span class="keyword">return</span> tacoId;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Then in <code>OrderController</code>:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span> </span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">processOrder</span><span class="params">(<span class="meta">@Valid</span> TacoOrder order, Errors errors, SessionStatus sessionStatus)</span> { </span><br><span class="line">  <span class="keyword">if</span> (errors.hasErrors()) { <span class="keyword">return</span> <span class="string">"orderForm"</span>; }</span><br><span class="line">  orderRepo.save(order); sessionStatus.setComplete();</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"redirect:/"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="spring-data-jdbc-repositories">Spring Data JDBC repositories</h2>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.data.repository.CrudRepository; </span><br><span class="line"><span class="keyword">import</span> tacos.TacoOrder; </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderRepository</span> <span class="keyword">extends</span> <span class="title class_">CrudRepository</span>&lt;TacoOrder, Long&gt; {</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>There’s no need to write an implementation. When the application starts, Spring Data will automatically generate an implementation on the fly. This means the repositories are ready to use from the get-go. Just inject them into the controllers and you’re done.</p>
<p>The only other thing we'll need to do is annotate our domain classes so that Spring Data JDBC will know how to persist them. Generally speaking, this means annotating the identity properties with <code>@Id</code>--so that Spring Data will know which field represents the object’s identity—and optionally annotating the class with <code>@Table</code>.</p>
<p>But if you’d prefer to map it to a different table name, then you can specify the table name as a parameter to <code>@Table</code> like this:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Table("Taco_Cloud_Order")</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TacoOrder</span> { ... }</span><br></pre></td></tr></tbody></table></figure>
<p>As shown here, <code>TacoOrder</code> will be mapped to a table named "Taco_Cloud_Order".</p>
<p>But if you want to explicitly define the column name mapping, you could annotate the property with <code>@Column</code> like this:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Column("customer_name")</span> </span><br><span class="line"><span class="meta">@NotBlank(message="Delivery name is required")</span> </span><br><span class="line"><span class="keyword">private</span> String deliveryName;</span><br></pre></td></tr></tbody></table></figure>
<p>In this case, <code>@Column</code> is specifying that the <code>deliveryName</code> property will be mapped to the column whose name is “customer_name”.</p>
<h3 id="preloading-data-with-commandlinerunner">Preloading data with CommandLineRunner</h3>
<p>When working with JdbcTemplate, we preloaded the Ingredient data at application startup using data.sql, which was executed against the database when the data source bean was created.</p>
<p>Spring Boot offers two useful interfaces for executing logic when an application starts up: <code>CommandLineRunner</code> and <code>ApplicationRunner</code>.</p>
<p>Both are functional interfaces that require that a single <code>run()</code> method be implemented. When the application starts up, any beans in the application context that implement <code>CommandLineRunner</code> or <code>ApplicationRunner</code> will have their <code>run()</code> methods invoked after the application context and all beans are wired up, but before anything else happens. This gives a convenient place for data to be loaded into the database.</p>
<h2 id="spring-data-jpa-repositories">Spring Data JPA repositories</h2>
<h3 id="annotating-the-domain-as-entities">1. Annotating the domain as entities</h3>
<p>In order to declare this as a JPA entity, Ingredient must be annotated with <code>@Entity</code>. And its id property must be annotated with <code>@Id</code> to designate it as the property that will uniquely identify the entity in the database.</p>
<p>In addition to the JPA-specific annotations, you’ll also note that you’ve added a <code>@NoArgsConstructor</code>annotation at the class level. JPA requires that entities have a no-arguments constructor, so Lombok’s <code>@NoArgsConstructor</code> does that for you.</p>
<p>You’ll also notice that there’s a new method, <code>createdAt()</code>, which is annotated with <code>@PrePersist</code>. You’ll use this to set the <code>createdAt</code> property to the current date and time before Taco is persisted.</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span> </span><br><span class="line"><span class="meta">@Entity</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TacoOrder</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">  <span class="meta">@Id</span> </span><br><span class="line">  <span class="meta">@GeneratedValue(strategy = GenerationType.AUTO)</span> </span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	<span class="meta">@OneToMany(cascade = CascadeType.ALL)</span></span><br><span class="line">	<span class="keyword">private</span> List&lt;Taco&gt; tacos = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">  </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addTaco</span><span class="params">(Taco taco)</span> { <span class="built_in">this</span>.tacos.add(taco); }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>To declare the relationship between a <code>Taco</code> and its associated Ingredient list, you annotate ingredients with <code>@ManyToMany</code>. A Taco can have many Ingredient objects, and an <code>Ingredient</code> can be a part of many <code>Tacos</code>.</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span> </span><br><span class="line"><span class="meta">@Entity</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TacoOrder</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Id</span> </span><br><span class="line">  <span class="meta">@GeneratedValue(strategy = GenerationType.AUTO)</span> </span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	<span class="meta">@OneToMany(cascade = CascadeType.ALL)</span></span><br><span class="line">	<span class="keyword">private</span> List&lt;Taco&gt; tacos = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">  </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addTaco</span><span class="params">(Taco taco)</span> { <span class="built_in">this</span>.tacos.add(taco); }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="declaring-jpa-repositories">2. Declaring JPA repositories</h3>
<p>As it turns out, <code>CrudRepository</code> works equally well for Spring Data JPA.</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.data.repository.CrudRepository; </span><br><span class="line"><span class="keyword">import</span> tacos.TacoOrder; </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderRepository</span> <span class="keyword">extends</span> <span class="title class_">CrudRepository</span>&lt;TacoOrder, Long&gt; { </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>In essence, Spring Data defines a sort of miniature domain-specific language (DSL) where persistence details are expressed in repository method signatures.</p>
<p>Spring Data knows that this method is intended to find Orders , because you’ve parameterized <code>CrudRepository</code> with <code>TacoOrder</code>. The method name, <code>findByDeliveryZip()</code>, makes it clear that this method should find all <code>TacoOrder</code> entities by matching their <code>deliveryZip</code> property with the value passed in as a parameter to the method.</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;TacoOrder&gt; <span class="title function_">readOrdersByDeliveryZipAndPlacedAtBetween</span><span class="params">( String deliveryZip, Date startDate, Date endDate)</span>;</span><br></pre></td></tr></tbody></table></figure>
<img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-02/ch3_JPA_methods.png" class="" title="ch3_JPA_methods">
<p>You can also name the method anything you want and annotate it with <code>@Query</code> to explicitly specify the query to be performed when the method is called.</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Query("Order o where o.deliveryCity='Seattle'")</span> </span><br><span class="line">List&lt;TacoOrder&gt; <span class="title function_">readOrdersDeliveredInSeattle</span><span class="params">()</span>;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="ch5-securing-spring">Ch5 Securing Spring</h1>
<p>Autoconfiguring Spring Security.</p>
<p>Defining custom user storage</p>
<p>Customizing the login page</p>
<p>Securing against CSRF attacks</p>
<p>No matter which password encoder you use, it’s important to understand that the password in the database is never decoded. Instead, the password that the user enters at login is encoded using the same algorithm, and it’s then compared with the encoded password in the database. That comparison is performed in the <code>PasswordEncoder</code>’s <code>matches()</code> method.</p>
<p>In addition to the password encoder, we’ll fill in this configuration class with more beans to define the specifics of security for our application. We’ll start by configuring a user store that can handle more than one user.</p>
<h2 id="customizing-user-authentication">Customizing user authentication</h2>
<h3 id="design-the-user-domain-and-persistence">Design the user domain and persistence</h3>
<p><code>User.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.</span><br><span class="line">                                          SimpleGrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor(access=AccessLevel.PRIVATE, force=true)</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">UserDetails</span> {</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@GeneratedValue(strategy=GenerationType.AUTO)</span></span><br><span class="line">  <span class="keyword">private</span> Long id;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String username;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String password;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String fullname;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String street;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String city;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String state;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String zip;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String phoneNumber;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities() {</span><br><span class="line">    <span class="keyword">return</span> Arrays.asList(<span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(<span class="string">"ROLE_USER"</span>));</span><br><span class="line">  }</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonExpired</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonLocked</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCredentialsNonExpired</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>In addition to defining a handful of properties, User also implements the <code>UserDetails</code> interface from Spring Security. Implementations of <code>UserDetails</code> will provide some essential user information to the framework, such as what authorities are granted to the user and whether the user’s account is enabled or not.</p>
<p>In addition to the CRUD operations provided by extending <code>CrudRepository</code>, <code>UserRepository</code> defines a <code>findByUsername()</code> method that you’ll use in the user details service to look up a User by their username.</p>
<p><code>UserRepository.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserRepository</span> <span class="keyword">extends</span> <span class="title class_">CrudRepository</span>&lt;User, Long&gt; {</span><br><span class="line">  User <span class="title function_">findByUsername</span><span class="params">(String username)</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>As you’ll recall, the <code>UserDetailsService</code> interface defines only a single <code>loadUserByUsername()</code> method.</p>
<p>In order to configure a user store for authentication purposes, you’ll need to declare a <code>UserDetailsService</code> bean.</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserDetailsService</span> {</span><br><span class="line">UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>The <code>loadUserByUsername()</code> method accepts a username and uses it to look up a <code>UserDetails</code> object.</p>
<p>As it turns out, Spring Security offers several out of the box implementations of <code>UserDetailsService</code>, including: An in-memory user store; A JDBC-based user store; An LDAP-backed user store.</p>
<p><code>UserRepositoryUserDetailsService.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserRepositoryUserDetailsService</span> </span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> {</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> UserRepository userRepo;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">UserRepositoryUserDetailsService</span><span class="params">(UserRepository userRepo)</span> {</span><br><span class="line">    <span class="built_in">this</span>.userRepo = userRepo;</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span></span><br><span class="line">      <span class="keyword">throws</span> UsernameNotFoundException {</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userRepo.findByUsername(username);</span><br><span class="line">    <span class="keyword">if</span> (user != <span class="literal">null</span>) {</span><br><span class="line">      <span class="keyword">return</span> user;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UsernameNotFoundException</span>(<span class="string">"User '"</span> + username + <span class="string">"' not found"</span>);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>The <code>loadByUsername()</code> method has one simple rule: it must never return null. Therefore, if the call to <code>findByUsername()</code> returns null , the lambda will throw a <code>UsernameNotFoundException</code>. Otherwise, the <code>User</code> that was found will be returned.</p>
<p>Now that you have a custom user details service that reads user information via a JPA repository, you just need a way to get users into the database in the first place. You need to create a registration page for Taco Cloud patrons to register with the application.</p>
<p><code>RegistrationController.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping("/register")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RegistrationController</span> {</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> UserRepository userRepo;</span><br><span class="line">  <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">RegistrationController</span><span class="params">(</span></span><br><span class="line"><span class="params">      UserRepository userRepo, PasswordEncoder passwordEncoder)</span> {</span><br><span class="line">    <span class="built_in">this</span>.userRepo = userRepo;</span><br><span class="line">    <span class="built_in">this</span>.passwordEncoder = passwordEncoder;</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@GetMapping</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">registerForm</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"registration"</span>;</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@PostMapping</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">processRegistration</span><span class="params">(RegistrationForm form)</span> {</span><br><span class="line">    userRepo.save(form.toUser(passwordEncoder));</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"redirect:/login"</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>RegistrationForm.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RegistrationForm</span> {</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> String username;</span><br><span class="line">  <span class="keyword">private</span> String password;</span><br><span class="line">  <span class="keyword">private</span> String fullname;</span><br><span class="line">  <span class="keyword">private</span> String street;</span><br><span class="line">  <span class="keyword">private</span> String city;</span><br><span class="line">  <span class="keyword">private</span> String state;</span><br><span class="line">  <span class="keyword">private</span> String zip;</span><br><span class="line">  <span class="keyword">private</span> String phone;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> User <span class="title function_">toUser</span><span class="params">(PasswordEncoder passwordEncoder)</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(</span><br><span class="line">        username, passwordEncoder.encode(password), </span><br><span class="line">        fullname, street, city, state, zip, phone);</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Like any typical Spring MVC controller, <code>RegistrationController</code> is annotated with <code>@Controller</code> to designate it as a controller and to mark it for component scanning. It’s also annotated with <code>@RequestMapping</code> such that it will handle requests whose path is <code>/register</code>. More specifically, a GET request for <code>/register</code> will be handled by the <code>registerForm()</code> method, which simply returns a logical view name of registration.</p>
<h3 id="securing-web-requests">Securing web requests</h3>
<p>The security requirements for Taco Cloud should require that a user be authenticated before designing tacos or placing orders. But the homepage, login page, and registration page should be available to unauthenticated users.</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span> </span><br><span class="line"><span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception { </span><br><span class="line">  <span class="keyword">return</span> http .authorizeRequests() .antMatchers(<span class="string">"/design"</span>,<span class="string">"/orders"</span>)</span><br><span class="line">    .access(<span class="string">"hasRole('USER')"</span>) </span><br><span class="line">    .antMatchers(<span class="string">"/"</span>, <span class="string">"/**"</span>).access(<span class="string">"permitAll()"</span>)</span><br><span class="line">    .and() .build();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>login.html</code></p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Taco Cloud<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">th:src</span>=<span class="string">"@{/images/TacoCloud.png}"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">th:if</span>=<span class="string">"${error}"</span>&gt;</span></span><br><span class="line">      Unable to login. Check your username and password.</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>New here? Click</span><br><span class="line">       <span class="tag">&lt;<span class="name">a</span> <span class="attr">th:href</span>=<span class="string">"@{/register}"</span>&gt;</span>here<span class="tag">&lt;/<span class="name">a</span>&gt;</span> to register.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">th:action</span>=<span class="string">"@{/login}"</span> <span class="attr">id</span>=<span class="string">"loginForm"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"username"</span>&gt;</span>Username: <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">id</span>=<span class="string">"username"</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"password"</span>&gt;</span>Password: <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">id</span>=<span class="string">"password"</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Login"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>The key things to note about this login page are the path it posts to and the names of the <code>username</code> and <code>password</code> fields. By default, Spring Security listens for login requests at <code>/login</code> and expects that the <code>username</code> and <code>password</code> fields be named <code>username</code> and <code>password</code>. This is configurable, however.</p>
<p>By default, a successful login will take the user directly to the page that they were navigating to when Spring Security determined that they needed to log in. If the user were to directly navigate to the login page, a successful login would take them to the root path (for example, the homepage). But you can change that by specifying a default success page:</p>
<p>Just as important as logging into an application is logging out. To enable logout, you simply need to call logout on the <code>HttpSecurity</code> object:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.and() </span><br><span class="line">  .logout()</span><br></pre></td></tr></tbody></table></figure>
<p>This sets up a security filter that intercepts POST requests to /logout. Therefore, to provide logout capability, you just need to add a logout form and button to the views in your application:</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">th:action</span>=<span class="string">"@{/logout}"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Logout"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="enabling-third-party-authentication">Enabling third-party authentication</h3>
<p>This type of authentication is based on OAuth2 or OpenID Connect (OIDC). Although OAuth2 is an authorization specification—and we’ll talk more about how to use it to secure REST APIs in chapter 9—it can be also used to perform authentication via a third-party website. OpenID Connect is another security specification that is based on OAuth2 to formalize the interaction that takes place during a third-party authentication.</p>
<h3 id="preventing-cross-site-request-forgery">Preventing cross-site request forgery</h3>
<p>Cross-site request forgery (CSRF) is a common security attack. It involves subjecting a user to code on a maliciously designed web page that automatically (and usually secretly) submits a form to another application on behalf of a user who is often the victim of the attack.</p>
<h3 id="applying-method-level-security">Applying method-level security</h3>
<p>Although it’s easy to think about security at the web request level, that’s not always where security constraints are best applied. Sometimes it’s better to verify that the user is authenticated and has been granted adequate authority at the point where the secured action will be performed.</p>
<p><code>OrderAdminService.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderAdminService</span> {</span><br><span class="line">  <span class="keyword">private</span> OrderRepository orderRepository;</span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">OrderAdminService</span><span class="params">(OrderRepository orderRepository)</span> {</span><br><span class="line">    <span class="built_in">this</span>.orderRepository = orderRepository;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PreAuthorize("hasRole('ADMIN')")</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteAllOrders</span><span class="params">()</span> {</span><br><span class="line">    orderRepository.deleteAll();</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>The <code>@PreAuthorize</code> annotation takes a SpEL expression and, if the expression evaluates to false, the method will not be invoked. On the other hand, if the expression evaluates to true, then the method will be allowed. In this case, <code>@PreAuthorize</code> is checking that the user has <code>ROLE_ADMIN</code> privilege. If so, then the method will be called and all orders will be deleted. Otherwise, it will be stopped in its tracks.</p>
<p>In the event that <code>@PreAuthorize</code> blocks the call, then Spring Security’s <code>AccessDeniedException</code> will be thrown.</p>
<p>In order for <code>@PreAuthorize</code> to work, you’ll need to enable global method security. For that, you’ll need to annotate the security configuration class with <code>@EnableGlobalMethodSecurity</code>:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span> </span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> { ... }</span><br></pre></td></tr></tbody></table></figure>
<p><code>AdminContoller.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping("/admin")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AdminController</span> {</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> OrderAdminService adminService;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">AdminController</span><span class="params">(OrderAdminService adminService)</span> {</span><br><span class="line">    <span class="built_in">this</span>.adminService = adminService;</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@GetMapping</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">showAdminPage</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"admin"</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PostMapping("/deleteOrders")</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">deleteAllOrders</span><span class="params">()</span> {</span><br><span class="line">    adminService.deleteAllOrders();</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"redirect:/admin"</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="knowing-your-user">Knowing your user</h3>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span> </span><br><span class="line"><span class="meta">@Entity</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TacoOrder</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line">  ...</span><br><span class="line">  <span class="meta">@Table(name="Taco_Order")</span></span><br><span class="line"></span><br><span class="line">	<span class="meta">@ManyToOne</span></span><br><span class="line">	<span class="keyword">private</span> User user;</span><br><span class="line">  ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>The <code>@ManyToOne</code> annotation on this property indicates that an order belongs to a single user, and, conversely, that a user may have many orders.</p>
<p>In <code>OrderController</code>, the <code>processOrder()</code> method is responsible for saving an order. It will need to be modified to determine who the authenticated user is and to call <code>setUser()</code> on the <code>TacoOrder</code> object to connect the order with the user.</p>
<p>There are several ways to determine who the user is. These are a few of the most common ways:</p>
<ul>
<li>Inject a <code>Principal</code> object into the controller method</li>
<li>Inject an <code>Authentication</code> object into the controller method</li>
<li>Use <code>SecurityContextHolder</code> to get at the security context</li>
<li>Use an <code>@AuthenticationPrincipal</code> annotated method</li>
</ul>
<p>Perhaps the cleanest solution of all, however, is to simply accept a <code>User</code> object in <code>processOrder()</code>, but annotate it with <code>@AuthenticationPrincipal</code> so that it will be the authentication’s principal:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">processOrder</span><span class="params">(<span class="meta">@Valid</span> Order order, Errors errors, </span></span><br><span class="line"><span class="params">    SessionStatus sessionStatus, </span></span><br><span class="line"><span class="params">    <span class="meta">@AuthenticationPrincipal</span> User user)</span> {</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (errors.hasErrors()) {</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"orderForm"</span>;</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  order.setUser(user);</span><br><span class="line">  </span><br><span class="line">  orderRepo.save(order);</span><br><span class="line">  sessionStatus.setComplete();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="string">"redirect:/"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>There’s one other way of identifying who the authenticated user is. You can obtain an <code>Authentication</code> object from the security context and then request its principal like this:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> SecurityContextHolder.getContext().getAuthentication(); </span><br><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) authentication.getPrincipal();</span><br></pre></td></tr></tbody></table></figure>
<p>Although this snippet is thick with security-specific code, it has one advantage over the other approaches described: it can be used anywhere in the application, not only in a controller’s handler methods. This makes it suitable for use in lower levels of the code.</p>
<p><code>SecurityConfig.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> {</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">(UserRepository userRepo)</span> {</span><br><span class="line">    <span class="keyword">return</span> username -&gt; {</span><br><span class="line">      <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userRepo.findByUsername(username);</span><br><span class="line">      <span class="keyword">if</span> (user != <span class="literal">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UsernameNotFoundException</span>(</span><br><span class="line">                      <span class="string">"User '"</span> + username + <span class="string">"' not found"</span>);</span><br><span class="line">    };</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> SecurityFilterChain <span class="title function_">filterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    <span class="keyword">return</span> http</span><br><span class="line">      .authorizeRequests()</span><br><span class="line">        .mvcMatchers(<span class="string">"/design"</span>, <span class="string">"/orders"</span>).hasRole(<span class="string">"USER"</span>)</span><br><span class="line">        .anyRequest().permitAll()</span><br><span class="line"></span><br><span class="line">      .and()</span><br><span class="line">        .formLogin()</span><br><span class="line">          .loginPage(<span class="string">"/login"</span>)</span><br><span class="line">          </span><br><span class="line">      .and()</span><br><span class="line">        .logout()</span><br><span class="line">          .logoutSuccessUrl(<span class="string">"/"</span>)</span><br><span class="line">          </span><br><span class="line">      <span class="comment">// Make H2-Console non-secured; for debug purposes</span></span><br><span class="line">      .and()</span><br><span class="line">        .csrf()</span><br><span class="line">          .ignoringAntMatchers(<span class="string">"/h2-console/**"</span>)</span><br><span class="line">  </span><br><span class="line">      <span class="comment">// Allow pages to be loaded in frames from the same origin; needed for H2-Console</span></span><br><span class="line">      .and()  </span><br><span class="line">        .headers()</span><br><span class="line">          .frameOptions()</span><br><span class="line">            .sameOrigin()</span><br><span class="line">            </span><br><span class="line">       .and()</span><br><span class="line">       .build();</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<script type="text&#x2F;javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.7.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.7.0/dist/mindmap.min.css"></article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/reading-notes/tags/software-dev/">software_dev</a><a class="post-meta__tags" href="/reading-notes/tags/spring/">spring</a></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-03/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/reading-notes/default_cover/sea-view-7219685_1280.jpg" onerror="onerror=null;src='/reading-notes/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Spring In Action Notes (3)</div></div></a></div><div class="next-post pull-right"><a href="/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-01/"><img class="next-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/reading-notes/default_cover/neural-network-3816319.svg" onerror="onerror=null;src='/reading-notes/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Spring In Action Reading Notes (1)</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-07/" title="Spring In Action Notes (7)"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/reading-notes/default_cover/sunflowers-7112463_1280.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-01</div><div class="title">Spring In Action Notes (7)</div></div></a></div><div><a href="/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-06/" title="Spring In Action Notes (6)"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/reading-notes/default_cover/gamer-6022003.svg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-29</div><div class="title">Spring In Action Notes (6)</div></div></a></div><div><a href="/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-04/" title="Spring In Action Notes (4)"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/reading-notes/default_cover/abstract-1264071.svg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-28</div><div class="title">Spring In Action Notes (4)</div></div></a></div><div><a href="/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-03/" title="Spring In Action Notes (3)"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/reading-notes/default_cover/sea-view-7219685_1280.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-28</div><div class="title">Spring In Action Notes (3)</div></div></a></div><div><a href="/reading-notes/cqNotes/SoftwareDev/SpringInAction/spring-in-action-notes-01/" title="Spring In Action Reading Notes (1)"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/reading-notes/default_cover/neural-network-3816319.svg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-26</div><div class="title">Spring In Action Reading Notes (1)</div></div></a></div><div><a href="/reading-notes/cqNotes/Java/cq_springboot/" title="cq_sprintboot"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/reading-notes/default_cover/abstract-1264071.svg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-01</div><div class="title">cq_sprintboot</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ch3-working-with-data"><span class="toc-number">1.</span> <span class="toc-text">Ch3 Working With Data</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#using-springs-jdbctemplate"><span class="toc-number">1.1.</span> <span class="toc-text">Using Spring’s JdbcTemplate</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#spring-data-jdbc-repositories"><span class="toc-number">1.2.</span> <span class="toc-text">Spring Data JDBC repositories</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#preloading-data-with-commandlinerunner"><span class="toc-number">1.2.1.</span> <span class="toc-text">Preloading data with CommandLineRunner</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#spring-data-jpa-repositories"><span class="toc-number">1.3.</span> <span class="toc-text">Spring Data JPA repositories</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#annotating-the-domain-as-entities"><span class="toc-number">1.3.1.</span> <span class="toc-text">1. Annotating the domain as entities</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#declaring-jpa-repositories"><span class="toc-number">1.3.2.</span> <span class="toc-text">2. Declaring JPA repositories</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ch5-securing-spring"><span class="toc-number">2.</span> <span class="toc-text">Ch5 Securing Spring</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#customizing-user-authentication"><span class="toc-number">2.1.</span> <span class="toc-text">Customizing user authentication</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#design-the-user-domain-and-persistence"><span class="toc-number">2.1.1.</span> <span class="toc-text">Design the user domain and persistence</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#securing-web-requests"><span class="toc-number">2.1.2.</span> <span class="toc-text">Securing web requests</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#enabling-third-party-authentication"><span class="toc-number">2.1.3.</span> <span class="toc-text">Enabling third-party authentication</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#preventing-cross-site-request-forgery"><span class="toc-number">2.1.4.</span> <span class="toc-text">Preventing cross-site request forgery</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#applying-method-level-security"><span class="toc-number">2.1.5.</span> <span class="toc-text">Applying method-level security</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#knowing-your-user"><span class="toc-number">2.1.6.</span> <span class="toc-text">Knowing your user</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="Increase font size"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="Decrease font size"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/reading-notes/js/utils.js"></script><script src="/reading-notes/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/reading-notes/js/search/local-search.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>if (document.getElementsByClassName('mermaid').length) {
  if (window.mermaidJsLoad) mermaid.init()
  else {
    getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(() => {
      window.mermaidJsLoad = true
      mermaid.initialize({
        theme: 'default',
      })
      false && mermaid.init()
    })
  }
}</script></div></div><!-- hexo injector body_end start --><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --></body></html>